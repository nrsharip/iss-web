<html>
  {% load static %}

  <title>{% block title %} Московская биржа {% endblock %}</title>

  <!-- https://www.favicon-generator.org/ -->
  <link rel="apple-touch-icon" sizes="57x57" href='{% static "moex/icon2.ico/apple-icon-57x57.png" %}'>
  <link rel="apple-touch-icon" sizes="60x60" href='{% static "moex/icon2.ico/apple-icon-60x60.png" %}'>
  <link rel="apple-touch-icon" sizes="72x72" href='{% static "moex/icon2.ico/apple-icon-72x72.png" %}'>
  <link rel="apple-touch-icon" sizes="76x76" href='{% static "moex/icon2.ico/apple-icon-76x76.png" %}'>
  <link rel="apple-touch-icon" sizes="114x114" href='{% static "moex/icon2.ico/apple-icon-114x114.png" %}'>
  <link rel="apple-touch-icon" sizes="120x120" href='{% static "moex/icon2.ico/apple-icon-120x120.png" %}'>
  <link rel="apple-touch-icon" sizes="144x144" href='{% static "moex/icon2.ico/apple-icon-144x144.png" %}'>
  <link rel="apple-touch-icon" sizes="152x152" href='{% static "moex/icon2.ico/apple-icon-152x152.png" %}'>
  <link rel="apple-touch-icon" sizes="180x180" href='{% static "moex/icon2.ico/apple-icon-180x180.png" %}'>
  <link rel="icon" type="image/png" sizes="192x192"  href='{% static "moex/icon2.ico/android-icon-192x192.png" %}'>
  <link rel="icon" type="image/png" sizes="32x32" href='{% static "moex/icon2.ico/favicon-32x32.png" %}'>
  <link rel="icon" type="image/png" sizes="96x96" href='{% static "moex/icon2.ico/favicon-96x96.png" %}'>
  <link rel="icon" type="image/png" sizes="16x16" href='{% static "moex/icon2.ico/favicon-16x16.png" %}'>
  <!-- This one causing 404 for android icons going out of Django 'static' parser -->
  <!-- <link rel="manifest" href='{% static "moex/icon2.ico/manifest.json" %}'>   -->

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content='{% static "moex/icon2.ico/ms-icon-144x144.png" %}'>
  <meta name="theme-color" content="#ffffff">

  <div id="mobile-device-test"></div>

  <!-- jQuery CDN – Latest Stable Versions: https://code.jquery.com/ -->
  <!-- jQuery Core – All Versions:          https://code.jquery.com/jquery/ -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>

  <!-- DataTables CDN: https://cdn.datatables.net/ -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script> -->
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">


  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  
  <!-- THIS SHOULD BE ADDED BEFORE CHART JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <!-- https://cdnjs.com/libraries/Chart.js -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.1"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.0.0-alpha/Chart.min.js"></script> -->
  
  <!-- https://github.com/chartjs/Chart.js -->
  <!-- <script src='{% static "moex/node_modules/Chart.js-master/samples/utils.js" %}'></script> -->

  <!-- Chart JS Plugins -->
  <!-- https://chartjs-plugin-datalabels.netlify.app/guide/ -->
  <script src='{% static "moex/node_modules/chartjs-plugin-datalabels/dist/chartjs-plugin-datalabels.min.js" %}'></script>

  <!-- https://github.com/chartjs/chartjs-chart-financial -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/luxon@1.24.1"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@0.2.1"></script> -->
  <!-- see https://github.com/chartjs/chartjs-chart-financial/commits/master -->
  <!-- commit before migration to chartjs 3.0.0 - f0c37e1dc24923a02c7793df8a292921db4b46cb -->
  <!-- <script src='{% static "moex/node_modules/chartjs-chart-financial-f0c37e1dc24923a02c7793df8a292921db4b46cb/docs/chartjs-chart-financial.js" %}' type="text/javascript"></script> -->
  <!-- <script src='{% static "moex/node_modules/chartjs-chart-financial-master/docs/index-1.js" %}' type="text/javascript"></script> -->

  <!-- https://github.com/chartjs/chartjs-plugin-zoom -->
  <!-- https://github.com/chartjs/chartjs-plugin-zoom/issues/53 -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src='{% static "moex/node_modules/chartjs-plugin-zoom/chartjs-plugin-zoom.min.js" %}' type="text/javascript"></script>

  <!-- https://github.com/ashiguruma/patternomaly -->
  <script src='{% static "moex/node_modules/patternomaly/dist/patternomaly.js" %}' charset='utf-8'></script>
  <!-- https://bashooka.com/coding/9-useful-javascript-color-libraries/ -->
  <!-- chroma.js -->
  <!-- https://gka.github.io/chroma.js/ -->
  <!-- https://www.npmjs.com/package/chroma-js -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src='{% static "moex/node_modules/chroma-js/chroma.min.js" %}'></script> -->
  <script src='{% static "moex/node_modules/chroma-js/chroma.js" %}'></script>

  <style>
    @media only screen and (max-width: 1100px) {
      #mobile-device-test { display: none; }
    }

    .container-fluid {
      padding-left: 0.25%;
      padding-right: 0.25%;
    }

    .mob-accordion-lev-1 {
      color: dimgray;
      font-weight: bold;
    }
    .mob-accordion-lev-1:hover {
      color: dimgray;
      font-weight: bold;
    }

    .mob-accordion-lev-2 {
      color: dimgray;
      font-weight: bold;
    }
    .mob-accordion-lev-2:hover {
      color: dimgray;
      font-weight: bold;
    }

    .mob-accordion-lev-3 {
      color: dimgray;
      font-weight: bold;
    }
    .mob-accordion-lev-3:hover {
      color: dimgray;
      font-weight: bold;
    }

    .mob-accordion-lev-4 {
      font-weight: bold;
    }
    .mob-accordion-lev-4:hover {
      font-weight: bold;
    }

    .table {
      font-size: 14px;
    }

    .row th:hover{
      background-color: lightblue;
    }
    .row td:hover{
      background-color: lightblue;
    }

    .card-body {
      padding: 0;
    }

    .index-security {
      /*color: #d62d20;*/
      color: chocolate;
    }
    .index-security:hover {
      /*color: #d62d20;*/
      color: chocolate;
    }

    .divider{
        width  :10px;
        height :auto;
        display:inline-block;
    }

    /*//!!! rotation*/
    /* https://stackoverflow.com/questions/24335274/how-to-rotate-text-vertically-at-table-column-header */
    /* http://jsfiddle.net/tsHunter/fxju7/5/ */
    .dataTable th {
        word-wrap: break-word;
    }
/*
    td, th {
        border: 1px solid #000;
    }
*/
    th.rank {
        width: 20px !important;
    }
/*
    th.wider {
        width: 120px !important;
    }
*/
    th.rotate {
      height: 150px;
      padding: 0px;
      /*width: 20px !important;*/
      font-weight: normal;
    }
    .rotate {
                 filter :  progid:DXImageTransform.Microsoft.BasicImage(rotation=0.083);  /* IE6,IE7 */
             -ms-filter : "progid:DXImageTransform.Microsoft.BasicImage(rotation=0.083)"; /* IE8 */
         -moz-transform : rotate(-90.0deg);  /* FF3.5+ */
          -ms-transform : rotate(-90.0deg);  /* IE9+ */
           -o-transform : rotate(-90.0deg);  /* Opera 10.5 */
      -webkit-transform : rotate(-90.0deg);  /* Safari 3.1+, Chrome */
              transform : rotate(-90.0deg);  /* Standard */
    }

    /* https://mdbootstrap.com/docs/jquery/tables/sort/ */
    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting:before,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_asc_disabled:after,
    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_desc:after,
    table.dataTable thead .sorting_desc:before,
    table.dataTable thead .sorting_desc_disabled:after,
    table.dataTable thead .sorting_desc_disabled:before {
      bottom: .5em;
    }
  </style>

  <div id="modal-secid" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-label-secid" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <span style="width: 100%; text-align: center; font-size: 20px;" class="modal-title" id="modal-label-secid"></span>
          <button type="button" class="close" data-dismiss="modal" aria-label="close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
      </div>
    </div>
  </div>

  <!-- https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/browser-builds.html -->
  <script src='{% static "moex/node_modules/elasticsearch-browser/elasticsearch.jquery.min.js" %}'></script>

  <script src='{% static "moex/scripts/global.js" %}'></script>
  <script>
    // https://stackoverflow.com/questions/50566194/correctly-accessing-django-static-files-from-external-javascript
    NG_STATIC_FILES = {
       //"HOME": "{% static '/pages/home.html' %}",
       //"SOMETHING_ELSE": "{% static '/pages/some-angular-template.html' %}",
       "SVG_QUESTION_CIRCLE" : '{% static "moex/node_modules/icons-master/icons/question-circle.svg" %}',
    };
    $( document ).ready(function() {      
      if( $('#mobile-device-test').css('display')=='none') {
        is_mobile = true;       
      }
      //is_mobile = true; // !!!!!!!!!!! REMOVE

      //!!!
      // http://iss.moex.com/iss/reference/5
      // http://iss.moex.com/iss/securities?limit=100&start=15980

      // http://iss.moex.com/iss/reference/28
      // http://iss.moex.com/iss/index
      jQuery.get("http://iss.moex.com/iss/index.json").done( function( data ) {
        jqXHR_iss_index_json = data;

        process_iss_index_markets();              // map_jqXHR_iss_index_json_markets_data              : engine -> markets
        process_iss_index_boardgroups();          // map_jqXHR_iss_index_json_boardgroups_data          : engine -> markets -> boardgroups
        process_iss_index_boards();               // map_jqXHR_iss_index_json_boards_data               : engine -> markets -> boardgroups -> boards
        process_iss_index_securitytypes();        // map_jqXHR_iss_index_json_securitytypes_data        : engine -> securitytypes
        process_iss_index_securitygroups();       // map_jqXHR_iss_index_json_securitygroups_data       : engine -> securitygroups
        process_iss_index_securitycollections();  // map_jqXHR_iss_index_json_securitycollection_data   : engine -> securitygroups -> securitycollection

        // http://iss.moex.com/iss/reference/24
        // http://iss.moex.com/iss/turnovers
        jQuery.get("http://iss.moex.com/iss/turnovers.json").done( function( data ) {
          jqXHR_iss_turnovers_json = data;
          // Nesting the jQuery GETs for turnovers and turnovers-columns to make sure they're both received
          // http://iss.moex.com/iss/reference/100
          // http://iss.moex.com/iss/turnovers/columns
          jQuery.get("http://iss.moex.com/iss/turnovers/columns.json").done( function( data ) {
            jqXHR_iss_turnovers_columns_json = data;

            var cell  = null;
            var row   = null;
            var col   = null;
            var analytics = null;
            var button = null;
            if (!is_mobile) {
              //!!! Hardcoding this for now...
              jqXHR_iss_index_json.engines.data[0][jqXHR_iss_index_json.engines.columns.indexOf("title")] = "Фондовый рынок";
              main_page_desktop();

              cell = $("#" + prefix_grid + marker_row_home);
              row       = grid_create_row(cell, marker_row_main);
              analytics = grid_create_col(row, "col-md-7 align-top", marker_col_left);
              col       = grid_create_col(row, "col-md-5 align-top", marker_col_right);
              // DON'T FORGET TO SET CELL TO COL
              cell = col;

              var columns = jqXHR_iss_index_json.engines.columns;
              var data    = jqXHR_iss_index_json.engines.data;

              $.each( data, function( i, val ) {
                var cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")]); // grid-engine-{id}
                var row = grid_create_row(cell, marker_row_main);
                var col = grid_create_col(row, "col-md-7 align-top", marker_col_left);
                          grid_create_col(row, "col-md-5 align-top", marker_col_right);
              });
              
              $("<h6/>", { class: "text-center", html: "Аналитика: " }).appendTo(grid_create_col(grid_create_row(analytics), "col-md-4 align-top"));
              
              button = $("<button/>", {type : "button", class : "btn btn-outline-primary btn-sm btn-block", html: "Граф: ценные бумаги"})
              button.mouseup(function (event) { open_in_new_tab ("analytics/graph-all-sec/") })
              button.appendTo(grid_create_col(grid_create_row(analytics), "col-md-4 align-top"));
              
              button = $("<button/>", {type : "button", class : "btn btn-outline-primary btn-sm btn-block", html: "Временной график: ценные бумаги по рынкам"})
              button.mouseup(function (event) { open_in_new_tab ("analytics/chart-timeline-market-lists/") })
              button.appendTo(grid_create_col(grid_create_row(analytics), "col-md-4 align-top"));
              
            } else {
              main_page_mobile();

              // TODO: finish this part
              var columns = jqXHR_iss_index_json.engines.columns;
              var data    = jqXHR_iss_index_json.engines.data;
              $.each( data, function( i, val ) {
                var cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")]); // grid-engine-{id}
                var row = grid_create_row(cell, marker_row_main);
                var col = grid_create_col(row, "col-md-12 align-top", marker_col_entire);
              });

              cell = $("#" + prefix_grid + marker_row_home);
            }

            // home
            var canvas = grid_create_canvas(prefix_doughnut + "iss-index-turnovers", cell);
            chart_create_doughnut_iss_index_turnovers(canvas);
            var table  = grid_create_table("iss-index-turnovers", cell);
            table_fill_with_iss_index_turnovers(table);

            //!!!
            //  create_iss_index_engines_accordions
            //    jqXHR_iss_index_json.engines.columns;
            //    jqXHR_iss_index_json.engines.data;
            //    each jqXHR_iss_index_json.engines.data
            //        |-> accordion-engine-{id}

            //    create_iss_index_engines_cards
            //      jqXHR_iss_index_json.engines.columns;
            //      jqXHR_iss_index_json.engines.data;
            //      each jqXHR_iss_index_json.engines.data
            //        accordion-engine-{id}
            //            |-> card-engine-{id}-markets
            //            |-> grid-engine-{id}-markets
            //            |-> card-engine-{id}-securitygroups
            //            |-> grid-engine-{id}-securitygroups
            //            |-> card-engine-{id}-securitytypes
            //            |-> grid-engine-{id}-securitytypes

            //      create_iss_index_engines_cards_accordions
            //        jqXHR_iss_index_json.engines.columns;
            //        jqXHR_iss_index_json.engines.data;
            //        each jqXHR_iss_index_json.engines.data;
            //                grid-engine-{id}-markets
            //                    |-> accordion-engine-{id}-markets
            //                grid-engine-{id}-securitytypes
            //                    |-> accordion-engine-{id}-securitytypes
            //                grid-engine-{id}-securitygroups
            //                    |-> accordion-engine-{id}-securitygroups

            //        create_iss_index_markets_cards
            //          map_jqXHR_iss_index_json_markets_data;
            //          jqXHR_iss_index_json.markets.columns;
            //          forEach map_jqXHR_iss_index_json_markets_data;
            //            engine = get_iss_index_engine_by_id(key);
            //            each val
            //                        accordion-engine-{id}-markets  
            //                            |-> card-market-{id}
            //                            |-> grid-market-{id}
            //                                |-> row: grid-market-{id}-main
            //                                |-> col: grid-market-{id}-entire

            // engines
            create_iss_index_engines_accordions();
            // markets, securitytypes, securitygroups
            create_iss_index_engines_cards();
            create_iss_index_engines_cards_accordions();
            
            // filling markets
            create_iss_index_markets_cards();             
            create_iss_index_markets_accordions();
            create_iss_index_markets_accordions_cards();

            // filling markets -> boardgroups
            create_iss_index_boardgroups_accordions();
            create_iss_index_boardgroups_cards();
            // filling markets -> boardgroups -> boards
            create_iss_index_boards_accordions();
            create_iss_index_boards_cards();

            // filling securitygroups
            create_iss_index_securitygroups_cards();
            create_iss_index_securitygroups_cards_accordions();

            // filling securitygroups-> securitycollection
            create_iss_index_securitycollections_cards();

            // filling securitytypes
            create_iss_index_securitytypes_cards();


            //!!! setting padding for card headers to 0 to make them more slim
            if (!is_mobile) {
              $(".card-header").css("padding-top",    "0")
              $(".card-header").css("padding-bottom", "0")
            }
          });
        });
      }).fail( function() {
        // TODO: FINISH THIS PART
        // Power Outage causing Internet off. Switching to saved JSONs for now
        alert("Failed GET: 'http://iss.moex.com/iss/index.json'");
        // http://iss.moex.com/iss/reference/28  - http://iss.moex.com/iss/index.json
        jqXHR_iss_index_json = {};
        // http://iss.moex.com/iss/reference/24  - http://iss.moex.com/iss/turnovers.json
        jqXHR_iss_turnovers_json = {};
        // http://iss.moex.com/iss/reference/100 - http://iss.moex.com/iss/turnovers/columns
        jqXHR_iss_turnovers_columns_json = {};

        jQuery.get("/static/moex/jqXHR/jqXHR_iss_index_json.json").done(function (data) {
          enc = new TextEncoder('cp1251'); 
          dec = new TextDecoder('cp1251'); 
          encoded = enc.encode(JSON.stringify(data))
          decoded = dec.decode(encoded);
          console.log(encoded)
          console.log(decoded)
        })
      });
    });
    function setup_event_listeners() {
      // look for "// events" comments for the places where the listeners are set
      if (!is_mobile) {
        // https://getbootstrap.com/docs/4.3/components/navs/#events
        // https://getbootstrap.com/docs/4.3/components/list-group/#events
        // 
        // Event Type    Description
        // show.bs.tab   This event fires on tab show, but before the new tab has been shown. Use event.target and event.relatedTarget to target the active tab and the previous active tab (if available) respectively.
        // shown.bs.tab  This event fires on tab show after a tab has been shown. Use event.target and event.relatedTarget to target the active tab and the previous active tab (if available) respectively.
        // hide.bs.tab   This event fires when a new tab is to be shown (and thus the previous active tab is to be hidden). Use event.target and event.relatedTarget to target the current active tab and the new soon-to-be-active tab, respectively.
        // hidden.bs.tab This event fires after a new tab is shown (and thus the previous active tab is hidden). Use event.target and event.relatedTarget to target the previous active tab and the new active tab, respectively.
      } else {
        // https://getbootstrap.com/docs/4.3/components/collapse/#events
        //
        // Event Type          Description
        // show.bs.collapse    This event fires immediately when the show instance method is called.
        // shown.bs.collapse   This event is fired when a collapse element has been made visible to the user (will wait for CSS transitions to complete).
        // hide.bs.collapse    This event is fired immediately when the hide method has been called.
        // hidden.bs.collapse  This event is fired when a collapse element has been hidden from the user (will wait for CSS transitions to complete).
      }
      // $('.nav-tabs a').on('show.bs.tab', process_event_show);
      
      //$('a[data-toggle="tab"]').on('show.bs.tab', process_event_show);
      //$('.accordion').on('show.bs.collapse', process_event_show);
      //$('.collapse').on('show.bs.collapse', process_event_show);
      //$('#collapse-stock-markets').on('show.bs.collapse', process_event_show);
      //$('#collapse-market-5').on('show.bs.collapse', process_event_show);
    }

    function process_event_click_secid(secid) {
      //console.log(secid)

      // https://stackoverflow.com/questions/18432394/how-to-make-twitter-bootstrap-modal-full-screen
      // https://www.w3schools.com/css/css_align.asp
      // https://getbootstrap.com/docs/4.2/components/modal/#via-javascript
      // https://getbootstrap.com/docs/4.2/components/modal/#options
      // https://getbootstrap.com/docs/4.2/components/modal/#methods

      // https://getbootstrap.com/docs/4.2/components/modal/#options
      // Name       Type                    Default     Description
      // backdrop   boolean                 true        Includes a modal-backdrop element. Alternatively, specify static for a backdrop which doesn't close the modal on click.
      //            or the string 'static'
      // keyboard   boolean                 true        Closes the modal when escape key is pressed
      // focus      boolean                 true        Puts the focus on the modal when initialized.
      // show       boolean                 true        Shows the modal when initialized.
      var options = {
        backdrop  : true,
        keyboard  : true,
        focus     : true,
        show      : true,
      }
      $('#modal-secid').find('.modal-dialog').css('max-width', '99%');
      $('#modal-secid').find('.modal-dialog').css('max-height', '99%');

      $('#modal-secid').find('.modal-header').css('padding-top',    '8px');
      $('#modal-secid').find('.modal-header').css('padding-bottom', '8px');

      $('#modal-label-secid').empty();
      var body = $('#modal-secid').find('.modal-body');
      // emptying the body
      body.empty();

      // Creating the grid container for the modal-body:
      var grid = $("<div/>", {'class' : "container-fluid", 'id' : prefix_grid + 'modal-secid'}) // grid-modal-secid
      grid.appendTo(body);
      var row = grid_create_row(grid, marker_row_main);                                         // grid-modal-secid-main
      var col_left    = null;
      var col_right   = null;
      var col_entire  = null;
      if (!is_mobile) {
        col_left    = grid_create_col(row, "col-md-7 align-top", marker_col_left);              // grid-modal-secid-main-left
        col_right   = grid_create_col(row, "col-md-5 align-top", marker_col_right);             // grid-modal-secid-main-right
      } else {
        col_entire  = grid_create_col(row, "col-md-12 align-top", marker_col_entire);           // grid-modal-secid-main-entire
      }
      // https://getbootstrap.com/docs/4.2/components/modal/#via-javascript
      $('#modal-secid').modal(options)

      var col = null;

      // security
      if (!map_secid_jqXHR_iss_securities_security_json.has(secid)) {
        if (!is_mobile) {
          col = col_right;
        } else {
          col = col_entire;
        }
        // http://iss.moex.com/iss/reference/13  - http://iss.moex.com/iss/securities/AFKS
        var subrow = grid_create_row(col, marker_row_securities);                         // grid-modal-secid-main-right-securities
        var subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);         // grid-modal-secid-main-right-securities-entire
        grid_create_spinner(subcol);

        var request = "https://iss.moex.com/iss" + 
          "/securities/" + secid + 
          ".json" 
        console.log("GET security " + secid + " description: " + request);
        jQuery.get(request).done( function( description ) {
          var map = new Map();
          map.set(map_key_security_description,  description.description);
          map.set(map_key_security_boards,       description.boards);
          map_secid_jqXHR_iss_securities_security_json.set(secid, map);

          var desc = get_iss_security_description (secid)

          $('#modal-label-secid').html("<b>" + secid + "</b> - " + desc.get("NAME"));

          var q = "";
          q += desc.get("SECID")  ?       desc.get("SECID") : "";
          q += desc.get("ISIN")   ? " " + desc.get("ISIN")  : "";
          // https://stackoverflow.com/questions/6544564/url-encode-a-string-in-jquery-for-an-ajax-request
          // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
          q = encodeURIComponent(q);

          var request = "https://iss.moex.com/iss" 
            + "/securities.json" 
            + "?"
            + "q=" + q
          console.log("GET security " + secid + " securities: " + request);
          jQuery.get(request).done( function( securities ) {
            if (securities.securities.data.length == 0) {
              alert("ERROR: Got 0 records for " + secid + " request: " + request);
              return;
            }
            if (securities.securities.data.length > 1) {
              console.log("WARNING: Got more than 1 record for " + secid + " request: " + request);
            }
            var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
            map.set(map_key_security_securities_iss,  securities.securities);
            map_secid_jqXHR_iss_securities_security_json.set(secid, map);

            subcol.empty()

            // securities
            // 
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html  : "Ценная бумага <font color='red'>" + secid + "</font>" }).appendTo(subcol);
            // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
            // https://getbootstrap.com/docs/4.2/content/tables/#small-table
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_securities, col, subrow, subcol);
            table.table.addClass("table-borderless");
            table_fill_with_iss_security_securities(table, secid);

            // description
            // 
            subrow = grid_create_row(col, marker_row_description);                   // grid-modal-secid-main-right-description
            subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);    // grid-modal-secid-main-right-description-entire
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Описание ценной бумаги"}).appendTo(subcol);
            // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
            // https://getbootstrap.com/docs/4.2/content/tables/#small-table
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_description, col, subrow, subcol);
            table.table.addClass("table-borderless");
            table_fill_with_iss_security_description(table, secid);
            
            // boards
            // 
            subrow = grid_create_row(col, marker_row_boards);                        // grid-modal-secid-main-right-boards
            subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);    // grid-modal-secid-main-right-boards-entire
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Режимы торгов ценной бумагой <font color='red'>" + secid + "</font>" }).appendTo(subcol);
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_boards, col, subrow, subcol);
            table_fill_with_iss_security_boards(table, secid);

            
            if (!is_mobile) {
              col = col_left;
            } else {
              col = col_entire;
            }

            // candles
            // 
            subrow = grid_create_row(col);                                              // grid-modal-secid-main-left-1
            subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-left-1-entire
            grid_create_spinner(subcol, "Загрузка свечей по режимам торгов...");

            get_iss_securities_security_board_candles(secid, description, function() {
              subcol.empty()
              var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
              if (map.has(map_key_security_candleborders)) {
                map.get(map_key_security_candles).forEach(function(durations, boardid) {
                  //console.log(boardid);
                  durations.forEach(function (arr_candles, interval) {
                    // candles
                    // 
                    subrow = grid_create_row(col);                                         // grid-modal-secid-main-left-{2..}
                    subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-left-{2..}-entire
                    var canvas = grid_create_canvas(
                      prefix_candlestick + prefix_iss + prefix_security + secid + infix_board + boardid + infix_interval + interval, 
                      col, 
                      subrow, 
                      subcol
                    );
                    //chart_create_candlestick_iss_securities_security_board_candles(canvas, secid, boardid, interval);
                    ///////////
                    chart_create_mixed_bar_line_iss_securities_security_board_candles(canvas, secid, boardid, interval);
                  })
                });
              } else {
                //subrow = grid_create_row(col_left);                                         // grid-modal-secid-main-left-1
                //subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-left-1-entire
                $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: Свечи"}).appendTo(subcol);
              }
            })
          }).fail( function() {
            // TODO: FINISH THIS PART
            alert ("ERROR: Request failed: " + request);
          });
        }).fail( function() {
          // TODO: FINISH THIS PART
          alert ("ERROR: Request failed: " + request);
        });
      } else {

        if (!is_mobile) {
          col = col_right;
        } else {
          col = col_entire;
        }

        var subrow = grid_create_row(col, marker_row_securities);                         // grid-modal-secid-main-right-securities
        var subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);         // grid-modal-secid-main-right-securities-entire

          var desc = get_iss_security_description (secid)
          $('#modal-label-secid').html("<b>" + secid + "</b> - " + desc.get("NAME"));

            // securities
            // 
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html  : "Ценная бумага <font color='red'>" + secid + "</font>" }).appendTo(subcol);
            // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
            // https://getbootstrap.com/docs/4.2/content/tables/#small-table
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_securities, col, subrow, subcol);
            table.table.addClass("table-borderless");
            table_fill_with_iss_security_securities(table, secid);

            // description
            // 
            subrow = grid_create_row(col, marker_row_description);                   // grid-modal-secid-main-right-description
            subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);    // grid-modal-secid-main-right-description-entire
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Описание ценной бумаги"}).appendTo(subcol);
            // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
            // https://getbootstrap.com/docs/4.2/content/tables/#small-table
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_description, col, subrow, subcol);
            table.table.addClass("table-borderless");
            table_fill_with_iss_security_description(table, secid);
            
            // boards
            // 
            subrow = grid_create_row(col, marker_row_boards);                        // grid-modal-secid-main-right-boards
            subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);    // grid-modal-secid-main-right-boards-entire
            $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Режимы торгов ценной бумагой <font color='red'>" + secid + "</font>" }).appendTo(subcol);
            var table = grid_create_table(prefix_iss + marker_table_security + postfix_boards, col, subrow, subcol);
            table_fill_with_iss_security_boards(table, secid);


              if (!is_mobile) {
                col = col_left;
              } else {
                col = col_entire;
              }
              // candles
              // 
              
              var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
              if (map.has(map_key_security_candleborders)) {
                map.get(map_key_security_candles).forEach(function(durations, boardid) {
                  //console.log(boardid);
                  durations.forEach(function (arr_candles, interval) {
                    // candles
                    // 
                    subrow = grid_create_row(col);                                         // grid-modal-secid-main-left-1
                    subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-left-1-entire
                    var canvas = grid_create_canvas(
                      prefix_candlestick + prefix_iss + prefix_security + secid + infix_board + boardid + infix_interval + interval, 
                      col, 
                      subrow, 
                      subcol
                    );
                    //chart_create_candlestick_iss_securities_security_board_candles(canvas, secid, boardid, interval);
                    chart_create_mixed_bar_line_iss_securities_security_board_candles(canvas, secid, boardid, interval);
                  })
                });
              } else {
                //subrow = grid_create_row(col_left);                                         // grid-modal-secid-main-left-1
                //subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-left-1-entire
                $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: Свечи"}).appendTo(subcol);
                ////////
              }

      }
    };
    function process_event_show_securities(event) {
      if (arr_pages_jqXHR_iss_securities_json.length == 0) {
        var start = 0;
        var limit = 100;
        var total = 0;
        var stop  = 0; //!!! change to 0 once ready to download all pages //////////

        var cell    = $("#" + prefix_grid + marker_row_securities);                           // grid-securities
        var row     = grid_create_row(cell, marker_row_load);                                 // grid-securities-load
        var col     = grid_create_col(row, "col-md-12 align-top", marker_col_entire);         // grid-securities-load-entire
        var subrow  = grid_create_row(col, marker_col_spinner);                               // grid-securities-load-entire-spinner
        var subcol  = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);      // grid-securities-load-entire-spinner-entire
        grid_create_spinner(subcol, "Загрузка списка бумаг торгуемых на московской бирже...");
        col   .css('font-size', "12px"); // entire
        subcol.css('font-size', "16px"); // spinner

        get_multipage_iss_securities(col, start, limit, total, stop, function () { 
          cell.empty();
          //*************************
          row = grid_create_row(cell, marker_row_main);                         // grid-securities-main
          col = grid_create_col(row, "col-md-12 align-top", marker_col_entire); // grid-securities-main-entire

          var table_securities = grid_create_table(prefix_iss + marker_table_securities, cell, row, col);
          table_fill_with_iss_securities(table_securities);

          row = grid_create_row(cell, "emitents");                         // grid-securities-emitents
          col = grid_create_col(row, "col-md-12 align-top", marker_col_entire); // grid-securities-emitents-entire

          var table = grid_create_table(prefix_iss + "emitents", cell, row, col);

          table_fill_with_iss_securities_aggr_by_emitent_id(table, table_securities);
        });
      }
    }
    function process_event_show_board (event, id) {
      //console.log(event);
      //console.log(id);
      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"
      var engine = get_iss_index_engine_by_id(board.engine_id);
      // "id"
      // "name"
      // "title"
      var market = get_iss_index_market_by_id(board.market_id);
      // 'id'          
      // 'name'        
      // 'title'       
      // 'marketplace' 
      // // added 2020-05-27
      // 'trade_engine_id'    
      // 'trade_engine_name'  
      // 'trade_engine_title'
      //console.log(board);

      var cell = $("#" + prefix_grid + prefix_board + id);  // grid-board-{id}
      var row     = null;
      var request = "";

      // securities
      if (!map_board_jqXHR_iss_engines_markets_boards_securities_json.has(id)) {
        // http://iss.moex.com/iss/reference/32  - https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities
        //                                       - https://iss.moex.com/iss/engines/stock/markets/shares/boards/TQBR/securities/columns
        
        //!!! Adding securities row for boards here:
            row            = grid_create_row(cell, marker_row_securities);                   // grid-board-{id}-securities
        var col_securities = grid_create_col(row, "col-md-12 align-top", marker_col_entire); // grid-board-{id}-securities-entire
        grid_create_spinner(col_securities);

        request = "https://iss.moex.com/iss" + 
          "/engines/"  + engine.name   + 
          "/markets/"  + market.name   + 
          "/boards/"   + board.boardid + 
          "/securities.json";
        //console.log(request);
        console.log("GET board " + board.boardid + " securities: " + request);
        jQuery.get(request).done( function( securities ) {
          request = "https://iss.moex.com/iss" + 
            "/engines/"  + engine.name   + 
            "/markets/"  + market.name   + 
            "/boards/"   + board.boardid + 
            "/securities/columns.json";
          //console.log(request);
          console.log("GET board " + board.boardid + " securities columns: " + request);
          jQuery.get(request).done( function( columns ) {
            map_board_jqXHR_iss_engines_markets_boards_securities_json.set(id, {
              'securities' : securities,
              'columns' : columns
            })
            col_securities.empty(); // cleaning from the spinner

            var subrow        = null;
            var subcol_entire = null;

            // *** Navigate back to the market - START
            subrow        = grid_create_row(col_securities);
            subcol_entire = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);
            grid_create_nav_return(
              subcol_entire, market.title, 
              $("#" + prefix_card + prefix_market + board.market_id), 
              ["#" + prefix_collapse + prefix_market + board.market_id]
            )
            // *** Navigate back to the market - END

            subrow        = grid_create_row(col_securities);
            subcol_entire = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);

            grid_create_spinner(subcol_entire, "Загрузка списка активов...");


            subcol_entire.empty()
            table = grid_create_table(prefix_iss + prefix_board + id + postfix_securities, col_securities, subrow, subcol_entire);

            if (!table_fill_with_iss_board_securities_v2(table, id)) {
              table.table.remove();
              $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: Таблица активов по режиму торгов"}).appendTo(subcol_entire);
            }
            // https://stackoverflow.com/questions/6998330/how-to-do-threading-in-javascript
            setTimeout( function() { 

            }, 3000);
            
          });
        });
      }

      // trades
      if (!map_board_jqXHR_iss_engines_markets_boards_trades_json.has(id)) {
        // http://iss.moex.com/iss/reference/34  - https://iss.moex.com/iss/engines/stock/markets/ccp/boards/PSRP/trades
        //                                       - https://iss.moex.com/iss/engines/stock/markets/ccp/boards/PSRP/trades/columns
        //!!! Adding trades row for boards here:
            row         = grid_create_row(cell, marker_row_trades);                       // grid-board-{id}-trades
        var col_trades  = grid_create_col(row, "col-md-12 align-top", marker_col_entire); // grid-board-{id}-trades-entire
        grid_create_spinner(col_trades);

        request = "https://iss.moex.com/iss" + 
          "/engines/"  + engine.name   + 
          "/markets/"  + market.name   + 
          "/boards/"   + board.boardid + 
          "/trades.json"
          + "?"
          + "reversed=1"
          // + "?date=2020-05-29"; //!!! remove for the weekdays
          // UPD: there's no 'date' argument for the request - no data available for previous dates
        console.log("GET board " + board.boardid + " trades: " + request);
        jQuery.get(request).done( function( trades ) {
          request = "https://iss.moex.com/iss" + 
            "/engines/"  + engine.name   + 
            "/markets/"  + market.name   + 
            "/boards/"   + board.boardid + 
            "/trades/columns.json";
          //console.log(request);
          console.log("GET board " + board.boardid + " trades columns: " + request);
          jQuery.get(request).done( function( columns ) {

            map_board_jqXHR_iss_engines_markets_boards_trades_json.set(id, {
              'trades' : trades,
              'columns' : columns
            })
            if (trades.trades.columns.indexOf("QUANTITY") < 0) {
              console.log ("WARNING (board: " + board.boardid + "): no QUANTITY column in trades received")
            }
            if (trades.trades.columns.indexOf("VALUE") < 0) {
              console.log ("WARNING (board: " + board.boardid + "): no VALUE column in trades received")
            }

            // https://stackoverflow.com/questions/41900798/javascript-how-group-and-sum-values-from-multidimensional-array
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce
            map_aggr_by_SECID_jqXHR_iss_engines_markets_boards_trades = trades.trades.data.reduce(function (accumulator, current_value) {
              // columns: Array(18)
              // 0: "TRADENO"
              // 1: "TRADETIME"
              // 2: "BOARDID"
              // 3: "SECID"
              // 4: "PRICE"
              // 5: "QUANTITY"
              // 6: "VALUE"
              // 7: "PERIOD"
              // 8: "YIELD"
              // 9: "TRADETIME_GRP"
              // 10: "SYSTIME"
              // 11: "BUYSELL"
              // 12: "ACCRUEDINT"
              // 13: "REPORATE"
              // 14: "REPOVALUE"
              // 15: "REPO2VALUE"
              // 16: "REPOTERM"
              // 17: "DECIMALS"
              if (!accumulator.has(current_value[trades.trades.columns.indexOf("SECID")])) {
                accumulator.set(current_value[trades.trades.columns.indexOf("SECID")], current_value.slice());
              } else {
                var value = accumulator.get(current_value[trades.trades.columns.indexOf("SECID")]);
                if (trades.trades.columns.indexOf("QUANTITY") >= 0) {
                  value[trades.trades.columns.indexOf("QUANTITY")] += current_value[trades.trades.columns.indexOf("QUANTITY")];
                }
                if (trades.trades.columns.indexOf("VALUE") >= 0) {
                  value[trades.trades.columns.indexOf("VALUE")]    += current_value[trades.trades.columns.indexOf("VALUE")];
                }
              }
              return accumulator;
            }, new Map());

            col_trades.empty(); // cleaning from the spinner

            var subrow        = grid_create_row(col_trades, marker_row_aggr);
            var subcol_entire = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);

            var subsubrow         = null;
            var subsubcol_entire  = null;

            // *** Navigate back to the market - START
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            grid_create_nav_return(
              subsubcol_entire, market.title, 
              $("#" + prefix_card + prefix_market + board.market_id), 
              ["#" + prefix_collapse + prefix_market + board.market_id]
            )
            // *** Navigate back to the market - END

            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            canvas            = grid_create_canvas(
              prefix_doughnut + prefix_iss + prefix_board + id + postfix_trades + infix_aggr + "SECID" + infix_sort + "VALUE", 
              subcol_entire, 
              subsubrow, 
              subsubcol_entire
            );
            if (!chart_create_doughnut_iss_board_trades_aggr_by_secid(canvas, id, 4, "VALUE")) {
              canvas.canvas.remove();
              $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: График"}).appendTo(subsubcol_entire);
            }

            // *** Navigate back to the market - START
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            grid_create_nav_return(
              subsubcol_entire, market.title, 
              $("#" + prefix_card + prefix_market + board.market_id), 
              ["#" + prefix_collapse + prefix_market + board.market_id]
            )
            // *** Navigate back to the market - END
            
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            canvas            = grid_create_canvas(
              prefix_doughnut + prefix_iss + prefix_board + id + postfix_trades + infix_aggr + "SECID" + infix_sort + "QUANTITY", 
              subcol_entire, 
              subsubrow, 
              subsubcol_entire
            );
            if (!chart_create_doughnut_iss_board_trades_aggr_by_secid(canvas, id, 4, "QUANTITY")) {
              canvas.canvas.remove();
              $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: График"}).appendTo(subsubcol_entire);
            }

            // *** Navigate back to the market - START
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            grid_create_nav_return(
              subsubcol_entire, market.title, 
              $("#" + prefix_card + prefix_market + board.market_id), 
              ["#" + prefix_collapse + prefix_market + board.market_id]
            )
            // *** Navigate back to the market - END

            var table = null;
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            table             = grid_create_table(prefix_iss + prefix_board + id + postfix_trades + infix_aggr + "SECID", subcol_entire, subsubrow, subsubcol_entire);
            if (!table_fill_with_iss_board_trades_aggr_by_secid(table, id)) {
              table.table.remove();
              $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: Агрегированные итоги торгов"}).appendTo(subsubcol_entire);
            }

            // TODO: uncomment below to put trades in a separate row
            //subrow        = grid_create_row(col_trades, marker_row_trades);
            //subcol_entire = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);

            // *** Navigate back to the market - START
            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            grid_create_nav_return(
              subsubcol_entire, market.title, 
              $("#" + prefix_card + prefix_market + board.market_id), 
              ["#" + prefix_collapse + prefix_market + board.market_id]
            )
            // *** Navigate back to the market - END


            subsubrow         = grid_create_row(subcol_entire);
            subsubcol_entire  = grid_create_col(subsubrow, "col-md-12 align-top", marker_col_entire);
            grid_create_spinner(subsubcol_entire, "Загрузка торгов...");
            
            subsubcol_entire.empty()
            table = grid_create_table(prefix_iss + prefix_board + id + postfix_trades, subcol_entire, subsubrow, subsubcol_entire);
            if (!table_fill_with_iss_board_trades_v2(table, id)) {
              table.table.remove();
              $("<div/>", { 'class' : "not-available", 'html' : "Данные отсутствуют: Все сделки по режиму торгов"}).appendTo(subsubcol_entire);
            }

            // https://stackoverflow.com/questions/6998330/how-to-do-threading-in-javascript
            setTimeout( function() { 

            }, 3000);
          });
        });
      }
    }
    function process_event_show_market (event, id) {
      //console.log(event);
      //console.log(id);
      var market = get_iss_index_market_by_id(id);
      //console.log(market);

      var cell = $("#" + prefix_grid + prefix_market + id);                                                                 // grid-market-{id}
      if (cell.find("#" + prefix_grid + prefix_market + id + "-" + marker_row_main).length > 0) {
        cell = $("#" + prefix_grid + prefix_market + id + "-" + marker_row_main);                                           // grid-market-{id}-main
        if (cell.find("#" + prefix_grid + prefix_market + id + "-" + marker_row_main + "-" + marker_col_entire).length > 0) {
          cell = $("#" + prefix_grid + prefix_market + id + "-" + marker_row_main + "-" + marker_col_entire);               // grid-market-{id}-main-entire
        }
      }

      if (!map_market_jqXHR_iss_engines_markets_turnovers_json.has(id)) {
        // http://iss.moex.com/iss/reference/96  - https://iss.moex.com/iss/engines/stock/markets/index/turnovers
        //                                       - https://iss.moex.com/iss/engines/stock/markets/index/turnovers/columns
        var row = grid_create_row(cell, marker_row_turnovers);
        var col = grid_create_col(row, "col-md-12 align-top");
        grid_create_spinner(col);

        request = "https://iss.moex.com/iss"
          + "/engines/" + market.trade_engine_name 
          + "/markets/" + market.name 
          + "/turnovers.json";
        //console.log(request);
        console.log("GET market " + market.name + " turnovers: " + request);
        jQuery.get(request).done( function( turnovers ) {
          if (turnovers.turnovers.error !== undefined) {
            console.log(turnovers.turnovers);
            col.empty(); // cleaning from the spinner
            return;
          }

          request = "https://iss.moex.com/iss"
            + "/engines/" + market.trade_engine_name 
            + "/markets/" + market.name 
            + "/turnovers/columns.json";
          //console.log(request);
          console.log("GET market " + market.name + " turnovers columns: " + request);
          jQuery.get(request).done( function( columns ) {
            map_market_jqXHR_iss_engines_markets_turnovers_json.set(id, {
              'turnovers' : turnovers,
              'columns' : columns
            })

            col.empty(); // cleaning from the spinner
            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var canvas = grid_create_canvas(prefix_doughnut + prefix_iss + prefix_market + id + postfix_turnovers, col, subrow, subcol);
            if (!chart_create_doughnut_iss_market_turnovers(canvas, id, 3)) {
              canvas.canvas.remove();
            }

            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var table  = grid_create_table(prefix_iss + prefix_market + id + postfix_turnovers, col, subrow, subcol);
            table_fill_with_iss_market_turnovers(table, id);
          });
        });
      }
    }
    function process_event_show_engine (event, id) {
      //console.log(event);
      //console.log(id);
      var engine = get_iss_index_engine_by_id(id);
      //console.log(engine);

      //!!!
      if (!is_mobile) {
        //$("#" + prefix_collapse + prefix_engine + engine.id + postfix_markets).collapse("show");
        //$("#" + prefix_collapse + prefix_engine + engine.id + postfix_securitytypes).collapse("show");
        //$("#" + prefix_collapse + prefix_engine + engine.id + postfix_securitygroups).collapse("show");
      }

      var cell = $("#" + prefix_grid + prefix_engine + id);                                                                 // grid-engine-{id}
      if (cell.find("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main).length > 0) {
        cell = $("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main);                                           // grid-engine-{id}-main
        if (cell.find("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main + "-" + marker_col_right).length > 0) {
          cell = $("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main + "-" + marker_col_right);                // grid-engine-{id}-main-right
          //!!!
          cell.css("max-height",$("body").outerHeight() - $("#tabs-main").outerHeight());
          cell.css("min-height",$("body").outerHeight() - $("#tabs-main").outerHeight());
          // https://getbootstrap.com/docs/4.4/utilities/overflow/
          // https://getbootstrap.com/docs/4.4/utilities/position/
          cell.addClass("overflow-auto sticky-top");
        }
        if (cell.find("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main + "-" + marker_col_entire).length > 0) {
          cell = $("#" + prefix_grid + prefix_engine + id + "-" + marker_row_main + "-" + marker_col_entire);               // grid-engine-{id}-main-entire
        }
      }

      if (!map_engine_jqXHR_iss_engines_turnovers_json.has(id)) {
        // http://iss.moex.com/iss/reference/95  - https://iss.moex.com/iss/engines/stock/turnovers
        //                                       - https://iss.moex.com/iss/engines/stock/turnovers/columns
        var row = grid_create_row(cell, marker_row_turnovers);
        var col = grid_create_col(row, "col-md-12 align-top");
        grid_create_spinner(col);

        jQuery.get("https://iss.moex.com/iss/engines/" + engine.name + "/turnovers.json").done( function( turnovers ) {
          if (turnovers.turnovers.error !== undefined) {
            console.log(turnovers.turnovers);
            col.empty(); // cleaning from the spinner
            return;
          }
          jQuery.get("https://iss.moex.com/iss/engines/" + engine.name + " /turnovers/columns.json").done( function( columns ) {
            map_engine_jqXHR_iss_engines_turnovers_json.set(id, {
              'turnovers' : turnovers,
              'columns' : columns
            })

            //console.log(map_engine_jqXHR_iss_engines_turnovers_json);
            //console.log($(event.target));

            col.empty(); // cleaning from the spinner
            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var canvas = grid_create_canvas(prefix_doughnut + prefix_iss + prefix_engine + id + postfix_turnovers, col, subrow, subcol);
            if (!chart_create_doughnut_iss_engine_turnovers(canvas, id, 2)) {
              canvas.canvas.remove();
            }

            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var table  = grid_create_table(prefix_iss + prefix_engine + id + postfix_turnovers, col, subrow, subcol);
            table_fill_with_iss_engine_turnovers(table, id);

            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var canvas = grid_create_canvas(prefix_doughnut + prefix_iss + prefix_engine + id + postfix_turnoverssectors, col, subrow, subcol);
            if (!chart_create_doughnut_iss_engine_turnoverssectors(canvas, id, 1)) {
              canvas.canvas.remove();
            }

            var subrow = grid_create_row(col);
            var subcol = grid_create_col(subrow, "col-md-12 align-top");
            var table  = grid_create_table(prefix_iss + prefix_engine + id + postfix_turnovers, col, subrow, subcol);
            table_fill_with_iss_engine_turnoverssectors(table, id);
          });
        });
      }
    }
    function process_event_show (event) {
      //console.log("From: " + $(event.relatedTarget).attr('id') + " to: " +$(event.target).attr('id'));
      //console.log($(event.relatedTarget).attr('id'));
      //console.log($(event.target).attr('id'));
      //console.log(event);
      //alert($(event.target).attr('id'));

      //                                             m[1]           m[2]            m[3]             m[4]             m[5]
      var m = $(event.target).attr('id').match(/([0-9a-zA-Z]+-)([0-9a-zA-Z]+-?)([0-9a-zA-Z]+-?)?([0-9a-zA-Z]+-?)?([0-9a-zA-Z]+-?)?/);
      //console.log(m);

      switch (m[1]) {
        case prefix_tab:
        case prefix_collapse:
          switch (m[2]) {
            case prefix_market:
              // alert("prefix_market");
              if (m[4] === undefined) {
                // alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, ""));
                process_event_show_market( event, parseInt(m[3].replace(/-/, "")) );
              } else {
                switch (m[4]) {
                  case postfix_boardgroups.replace(/-/, ""):
                    //alert('Market ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, "") + " Boardgroups");
                    break;
                  default:
                    alert("No match for prefix_market m[4]: " + m[4]);
                    break;
                }
              }
              break;
            case prefix_securitytype:
              alert("prefix_securitytype");
              break;
            case prefix_securitygroup:
              //alert("prefix_securitygroup");
              break;
            case prefix_boardgroup:
              //alert("prefix_boardgroup");
              break;
            case prefix_board:
              //alert("prefix_board");
              if (m[4] === undefined) {
                // alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, ""));
                process_event_show_board( event, parseInt(m[3].replace(/-/, "")) );
              } else {
                switch (m[4]) {
                  default:
                    alert("No match for prefix_board m[4]: " + m[4]);
                    break;
                }
              }
              break;

            case prefix_engine:
              if (m[4] === undefined) {
                // alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, ""));
                process_event_show_engine( event, parseInt(m[3].replace(/-/, "")) );
              } else {
                switch (m[4]) {
                  case postfix_markets.replace(/-/, ""):
                    //alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, "") + " Markets");
                    break;
                  case postfix_securitygroups.replace(/-/, ""):
                    //alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, "") + " Security Groups");
                    break;
                  case postfix_securitytypes.replace(/-/, ""):
                    //alert('Engine ' + m[3].replace(/-/, "") + " " + m[1].replace(/-/, "") + " Security Types");
                    break;
                  default:
                    alert("No match for prefix_engine m[4]: " + m[4]);
                    break;
                }
              }
              break;
            case marker_row_securities:
              // we're in securities
              process_event_show_securities(event);
              break;
            case marker_row_home:
              // we're home
              break;
            default:
              alert("No match for m[2]: " + m[2]);
              break;
          }
          break;
        default:
          alert("No match for m[1]: " + m[1]);
          break;
      }
    }

    function create_iss_index_engines_accordions () {
      var columns = jqXHR_iss_index_json.engines.columns;
      var data    = jqXHR_iss_index_json.engines.data;

      // columns: Array(3)
      // 0: "id"
      // 1: "name"
      // 2: "title"

      $.each( data, function( i, val ) {
        var cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")]);                                                                 // grid-engine-{id}
        if (!is_mobile && (cell.find("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main).length > 0)) {           // no mobile allowed here
          cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main);                                           // grid-engine-{id}-main
          if (cell.find("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main + "-" + marker_col_left).length > 0) {
            cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main + "-" + marker_col_left);                 // grid-engine-{id}-main-left
          }
          //if (cell.find("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main + "-" + marker_col_entire).length > 0) {
          //  cell = $("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + "-" + marker_row_main + "-" + marker_col_entire);             // grid-engine-{id}-main-entire
          //}
        }

        var row = grid_create_row(cell); 
        var col = grid_create_col(row, "col-md-12 align-top");
        var accordion = $("<div/>", {
          'class':"accordion",  
          'id' : prefix_accordion + prefix_engine + val[columns.indexOf("id")]}); // accordion-engine-{id}
        accordion.appendTo(col);
        
        if (!is_mobile) {
          // Only root accorion needed event listeners - it will propagate to the nested accordions/collapses as well
          accordion.on('show.bs.collapse', process_event_show); // events
        }
      });
    }
    function create_iss_index_engines_cards () {
      var columns = jqXHR_iss_index_json.engines.columns;
      var data    = jqXHR_iss_index_json.engines.data;
      $.each( data, function( i, val ) {
        var accordion = $("#" + prefix_accordion + prefix_engine + val[columns.indexOf("id")]); // accordion-engine-{id}
        if (map_jqXHR_iss_index_json_markets_data.has(val[columns.indexOf("id")])) {
          var badge = $("<span/>", {
            'class': "badge badge-info",  
            'html' : map_jqXHR_iss_index_json_markets_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          create_card(                                                      // grid-engine-{id}-markets
            prefix_engine + val[columns.indexOf("id")] + postfix_markets,   // card-engine-{id}-markets
            "<font color='darkcyan'>" + "РЫНКИ " + "</font>" + badge, 
            "text-left mob-accordion-lev-2"
          ).appendTo(accordion);
        }
        if (map_jqXHR_iss_index_json_securitygroups_data.has(val[columns.indexOf("name")])) {
          var badge = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : map_jqXHR_iss_index_json_securitygroups_data.get(val[columns.indexOf("name")]).length
          }).wrap('<p/>').parent().html();
          create_card(                                                            // grid-engine-{id}-securitygroups
            prefix_engine + val[columns.indexOf("id")] + postfix_securitygroups,  // card-engine-{id}-securitygroups
            "<font color='chocolate'>" + "ИНСТРУМЕНТЫ:" + "</font>" + 
            "<font color='chocolate'>" + " Группы " + "</font>" + badge, 
            "text-left mob-accordion-lev-2"
          ).appendTo(accordion);
        }
        if (map_jqXHR_iss_index_json_securitytypes_data.has(val[columns.indexOf("id")])) {
          var badge = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : map_jqXHR_iss_index_json_securitytypes_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          create_card(                                                            // grid-engine-{id}-securitytypes
            prefix_engine + val[columns.indexOf("id")] + postfix_securitytypes,   // card-engine-{id}-securitytypes
            "<font color='chocolate'>" + "ИНСТРУМЕНТЫ:" + "</font>" + " Типы " + badge, 
            "text-left mob-accordion-lev-2"
          ).appendTo(accordion);
        }
      });
    }
    function create_iss_index_engines_cards_accordions () {
      var columns = jqXHR_iss_index_json.engines.columns;
      var data    = jqXHR_iss_index_json.engines.data;
      $.each( data, function( i, val ) {
        if (map_jqXHR_iss_index_json_markets_data.has(val[columns.indexOf("id")])) {
          var row = grid_create_row($("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + postfix_markets ));          // grid-engine-{id}-markets
          var col = grid_create_col(row, "col-md-12 align-top");
          var accordion = $("<div/>", {
            'class':"accordion",  
            'id' : prefix_accordion + prefix_engine + val[columns.indexOf("id")] + postfix_markets                                  // accordion-engine-{id}-markets
          });        
          accordion.appendTo(col);
        }
        if (map_jqXHR_iss_index_json_securitytypes_data.has(val[columns.indexOf("id")])) {
          var row = grid_create_row($("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + postfix_securitytypes ));    // grid-engine-{id}-securitytypes
          var col = grid_create_col(row, "col-md-12 align-top");
          var accordion = $("<div/>", {
            'class':"accordion",  
            'id' : prefix_accordion + prefix_engine + val[columns.indexOf("id")] + postfix_securitytypes                            // accordion-engine-{id}-securitytypes
          });  
          accordion.appendTo(col);
        }
        if (map_jqXHR_iss_index_json_securitygroups_data.has(val[columns.indexOf("name")])) {
          var row = grid_create_row($("#" + prefix_grid + prefix_engine + val[columns.indexOf("id")] + postfix_securitygroups ));   // grid-engine-{id}-securitygroups
          var col = grid_create_col(row, "col-md-12 align-top");
          var accordion = $("<div/>", {
            'class':"accordion",  
            'id' : prefix_accordion + prefix_engine + val[columns.indexOf("id")] + postfix_securitygroups                           // accordion-engine-{id}-securitygroups
          }); 
          accordion.appendTo(col);
        }
      });
    }
    function create_iss_index_markets_cards () {
      var map     = map_jqXHR_iss_index_json_markets_data;
      var columns = jqXHR_iss_index_json.markets.columns;
      // columns: Array(8)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_name"
      // 5: "market_title"
      // 6: "market_id"
      // 7: "marketplace"
      map.forEach( function( arr, key ) {
        var engine = get_iss_index_engine_by_id(key);
        var accordion = $("#" + prefix_accordion + prefix_engine + engine.id + postfix_markets);
        var index = 1;
        $.each( arr, function( i, val ) {
          var badges = "";
          if (map_jqXHR_iss_index_json_boardgroups_data
                .has(val[columns.indexOf("trade_engine_id")]) &&
              map_jqXHR_iss_index_json_boardgroups_data
                .get(val[columns.indexOf("trade_engine_id")])
                .has(val[columns.indexOf("market_id")])) {
            var badge = $("<span/>", {
              'class': "badge badge-primary",  
              'html' : "Режимы торгов - Групп: " + map_jqXHR_iss_index_json_boardgroups_data
                        .get(val[columns.indexOf("trade_engine_id")])
                        .get(val[columns.indexOf("market_id")])
                        .length
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }

          create_card(                                                    // grid-market-{id}
            prefix_market + val[columns.indexOf("market_id")],            // card-market-{id}
            "<font color='darkcyan'>" + index + ". <span class='search'>" + val[columns.indexOf("market_title")] + "</span></font>" + badges, 
            "text-left mob-accordion-lev-3"
          ).appendTo(accordion);
          index = index + 1;

          //!!! Adding main row for markets here:
          var cell = $("#" + prefix_grid + prefix_market + val[columns.indexOf("market_id")]);
          var row = grid_create_row(cell, marker_row_main);
          var col = grid_create_col(row, "col-md-12 align-top", marker_col_entire);
        });
      });
    }
    function create_iss_index_markets_accordions () {
      var columns = jqXHR_iss_index_json.markets.columns;
      var data    = jqXHR_iss_index_json.markets.data;
      // columns: Array(8)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_name"
      // 5: "market_title"
      // 6: "market_id"
      // 7: "marketplace"
      $.each( data, function( i, val ) {
        var row = grid_create_row($("#" + prefix_grid + prefix_market + val[columns.indexOf("market_id")]));                               // grid-market-{id}
        var col = grid_create_col(row, "col-md-12 align-top");
        var accordion = $("<div/>", {'class':"accordion",  'id' : prefix_accordion + prefix_market + val[columns.indexOf("market_id")]});  // accordion-market-{id}
        accordion.appendTo(col);
      });
    }
    function create_iss_index_markets_accordions_cards () {
      var columns = jqXHR_iss_index_json.markets.columns;
      var data    = jqXHR_iss_index_json.markets.data;
      // columns: Array(8)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_name"
      // 5: "market_title"
      // 6: "market_id"
      // 7: "marketplace"
      $.each( data, function( i, val ) {
        var accordion = $("#" + prefix_accordion + prefix_market + val[columns.indexOf("market_id")]);  // accordion-market-{id}
        if (map_jqXHR_iss_index_json_boardgroups_data.has(val[columns.indexOf("trade_engine_id")]) &&
            map_jqXHR_iss_index_json_boardgroups_data
              .get(val[columns.indexOf("trade_engine_id")])
              .has(val[columns.indexOf("market_id")])) {
          var badge = $("<span/>", {
            'class': "badge badge-primary",  
            'html' : map_jqXHR_iss_index_json_boardgroups_data
                      .get(val[columns.indexOf("trade_engine_id")])
                      .get(val[columns.indexOf("market_id")])
                      .length
          }).wrap('<p/>').parent().html();
          create_card(                                                                // grid-market-{id}-boardgroups
            prefix_market + val[columns.indexOf("market_id")] + postfix_boardgroups,  // card-market-{id}-boardgroups
            "Режимы торгов: Группы " + badge, 
            "text-left mob-accordion-lev-4"
          ).appendTo(accordion);
        }
      });
    }
    function create_iss_index_boardgroups_accordions() {
      var columns = jqXHR_iss_index_json.markets.columns;
      var data    = jqXHR_iss_index_json.markets.data;
      // columns: Array(8)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_name"
      // 5: "market_title"
      // 6: "market_id"
      // 7: "marketplace"
      $.each( data, function( i, val ) {
        var row = grid_create_row($("#" + prefix_grid + prefix_market + val[columns.indexOf("market_id")] + postfix_boardgroups));  // grid-market-{id}-boardgroups
        var col = grid_create_col(row, "col-md-12 align-top");
        var accordion = $("<div/>", {
          'class':"accordion",  
          'id' : prefix_accordion + prefix_market + val[columns.indexOf("market_id")] + postfix_boardgroups                         // accordion-market-{id}-boardgroups
        });  
        accordion.appendTo(col);
      });
    }
    function create_iss_index_boardgroups_cards () {
      var map     = map_jqXHR_iss_index_json_boardgroups_data;
      var columns = jqXHR_iss_index_json.boardgroups.columns;
      // columns: Array(11)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_id"
      // 5: "market_name"
      // 6: "name"
      // 7: "title"
      // 8: "is_default"
      // 9: "board_group_id"
      // 10: "is_traded"
      map.forEach( function( map, key ) {     // engine_id
        var engine = get_iss_index_engine_by_id(key);
        map.forEach( function( arr, key ) {   // market_id
          var market = get_iss_index_market_by_id(key);

          var accordion = $("#" + prefix_accordion + prefix_market + market.id + postfix_boardgroups); // accordion-market-{id}-boardgroups
          var index = 1;
          $.each( arr, function( i, val ) {
            var badges = "";

            var badges = "";
            if (map_jqXHR_iss_index_json_boards_data
                  .has(val[columns.indexOf("trade_engine_id")]) &&
                map_jqXHR_iss_index_json_boards_data
                  .get(val[columns.indexOf("trade_engine_id")])
                  .has(val[columns.indexOf("market_id")]) &&
                map_jqXHR_iss_index_json_boards_data
                  .get(val[columns.indexOf("trade_engine_id")])
                  .get(val[columns.indexOf("market_id")])
                  .has(val[columns.indexOf("board_group_id")])
                  ) {
              var badge = $("<span/>", {
                'class': "badge badge-primary",  
                'html' : map_jqXHR_iss_index_json_boards_data
                          .get(val[columns.indexOf("trade_engine_id")])
                          .get(val[columns.indexOf("market_id")])
                          .get(val[columns.indexOf("board_group_id")])
                          .length
              }).wrap('<p/>').parent().html();
              badges = badges + " " + badge;
            }

            if (val[columns.indexOf("is_traded")] == 0) {
              var badge = $("<span/>", {
                'class': "badge badge-danger",  
                'html' : "закрыт"
              }).wrap('<p/>').parent().html();
              badges = badges + " " + badge;
            }
            create_card(                                                    // grid-boardgroup-{board_group_id}
              prefix_boardgroup + val[columns.indexOf("board_group_id")],   // card-boardgroup-{board_group_id}
              index + ". <b>Группа:</b> <span class='search'>" + val[columns.indexOf("title")] + "</span>" + badges, 
              "text-left mob-accordion-lev-5"
            ).appendTo(accordion);
            index = index + 1;
          });
        });
      });
    }
    function create_iss_index_boards_accordions() {
      var columns = jqXHR_iss_index_json.boardgroups.columns;
      var data    = jqXHR_iss_index_json.boardgroups.data;
      // columns: Array(11)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_id"
      // 5: "market_name"
      // 6: "name"
      // 7: "title"
      // 8: "is_default"
      // 9: "board_group_id"
      // 10: "is_traded"
      $.each( data, function( i, val ) {
        var row = grid_create_row($("#" + prefix_grid + prefix_boardgroup + val[columns.indexOf("board_group_id")] )); //+ postfix_boards));  // grid-boardgroup-{id}-boards
        var col = grid_create_col(row, "col-md-12 align-top");
        var accordion = $("<div/>", {
          'class':"accordion",  
          'id' : prefix_accordion + prefix_boardgroup + val[columns.indexOf("board_group_id")] + postfix_boards                               // accordion-boardgroup-{id}-boards
        });  
        accordion.appendTo(col);
      });
    }
    function create_iss_index_boards_cards () {
      var map     = map_jqXHR_iss_index_json_boards_data; // engine -> markets -> boardgroups -> boards
      var columns = jqXHR_iss_index_json.boards.columns;
      // columns: Array(9)
      // 0: "id"
      // 1: "board_group_id"
      // 2: "engine_id"
      // 3: "market_id"
      // 4: "boardid"
      // 5: "board_title"
      // 6: "is_traded"
      // 7: "has_candles"
      // 8: "is_primary"
      map.forEach( function( map, key ) {       // engine_id
        var engine = get_iss_index_engine_by_id(key);
        map.forEach( function( map, key ) {     // market_id
          var market = get_iss_index_market_by_id(key);
          map.forEach( function( arr, key ) {   // board_group_id
            var boardgroup = get_iss_index_boardgroup_by_id(key); 
            //console.log(key);
            var accordion = $("#" + prefix_accordion + prefix_boardgroup + boardgroup.id + postfix_boards); // accordion-boardgroup-{id}-boards
            var index = 1;
            $.each( arr, function( i, val ) {
              var badges = "";

              if (val[columns.indexOf("is_primary")] == 1) {
                var badge = $("<span/>", {
                  'class': "badge badge-success",  
                  'html' : "основной"
                }).wrap('<p/>').parent().html();
                badges = badges + " " + badge;
              }
              if (val[columns.indexOf("has_candles")] == 1) {
                var badge = $("<span/>", {
                  'class': "badge badge-warning",  
                  'html' : "свечи"
                }).wrap('<p/>').parent().html();
                badges = badges + " " + badge;
              }
              if (val[columns.indexOf("is_traded")] == 0) {
                var badge = $("<span/>", {
                  'class': "badge badge-danger",  
                  'html' : "закрыт"
                }).wrap('<p/>').parent().html();
                badges = badges + " " + badge;
              }
              create_card(                                    // grid-board-{id}
                prefix_board + val[columns.indexOf("id")],    // card-board-{id}
                // index + ". Режим: " + val[columns.indexOf("board_title")] + badges,
                "Режим: <span class='search'>" + val[columns.indexOf("board_title")] + "</span>" + badges,
                "text-left mob-accordion-lev-6"
              ).appendTo(accordion);
              index = index + 1;
            });
          });
        });
      });
    }
    function create_iss_index_securitygroups_cards () {
      var map     = map_jqXHR_iss_index_json_securitygroups_data;
      var columns = jqXHR_iss_index_json.securitygroups.columns;
      // columns: Array(4)
      // 0: "id"
      // 1: "name"
      // 2: "title"
      // 3: "is_hidden"
      map.forEach( function( arr, key ) {
        var engine = get_iss_index_engine_by_name(key);
        var accordion = $("#" + prefix_accordion + prefix_engine + engine.id + postfix_securitygroups);
        var index = 1;
        $.each( arr, function( i, val ) {

          var badges = "";
          if (map_jqXHR_iss_index_json_securitycollection_data
                .has(key) &&
              map_jqXHR_iss_index_json_securitycollection_data
                .get(key)
                .has(val[columns.indexOf("id")])
                ) {
            var badge = $("<span/>", {
              'class': "badge badge-danger",  
              'html' : map_jqXHR_iss_index_json_securitycollection_data
                        .get(key)
                        .get(val[columns.indexOf("id")])
                        .length + " коллекций инструментов"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }

          create_card(
            prefix_securitygroup + val[columns.indexOf("id")],  
            index + ". <span class='search'>" + val[columns.indexOf("title")] + "</span>" + badges, 
            "text-left mob-accordion-lev-3 index-security"
          ).appendTo(accordion);
          index = index + 1;
        });
      });
    }
    function create_iss_index_securitygroups_cards_accordions() {
      var columns = jqXHR_iss_index_json.securitygroups.columns;
      var data    = jqXHR_iss_index_json.securitygroups.data;
      // 0: "id"
      // 1: "name"
      // 2: "title"
      // 3: "is_hidden"
      $.each( data, function( i, val ) {
        var row = grid_create_row($("#" + prefix_grid + prefix_securitygroup + val[columns.indexOf("id")] )); // grid-securitygroup-{id}
        var col = grid_create_col(row, "col-md-12 align-top");
        var accordion = $("<div/>", {
          'class':"accordion",  
          'id' : prefix_accordion + prefix_securitygroup + val[columns.indexOf("id")]                         // accordion-securitygroup-{id}
        });
        accordion.appendTo(col);

        var engine = val[columns.indexOf("name")].match(/\b([a-zA-Z]+)_/)[1];
        var badges = "";
        if (map_jqXHR_iss_index_json_securitycollection_data
              .has(engine) &&
            map_jqXHR_iss_index_json_securitycollection_data
              .get(engine)
              .has(val[columns.indexOf("id")])
              ) {
          var badge = $("<span/>", {
            'class': "badge badge-danger",  
            'html' : map_jqXHR_iss_index_json_securitycollection_data
                      .get(engine)
                      .get(val[columns.indexOf("id")])
                      .length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge;
        }

        create_card(                                                                          // grid-securitygroup-{id}-securitycollections
          prefix_securitygroup + val[columns.indexOf("id")] + postfix_securitycollections,    // card-securitygroup-{id}-securitycollections
          "Коллекции инструментов" + badges, 
          "text-left mob-accordion-lev-4 index-security"
        ).appendTo(accordion);

        row = grid_create_row($("#" + prefix_grid + prefix_securitygroup + val[columns.indexOf("id")] + postfix_securitycollections));  // grid-securitygroup-{id}-securitycollections
        col = grid_create_col(row, "col-md-12 align-top");
        accordion = $("<div/>", {
          'class':"accordion",  
          'id' : prefix_accordion + prefix_securitygroup + val[columns.indexOf("id")] + postfix_securitycollections                     // accordion-securitygroup-{id}-securitycollections
        });
        accordion.appendTo(col);

      });
    }
    function create_iss_index_securitycollections_cards() {
      var columns = jqXHR_iss_index_json.securitycollections.columns;
      var data    = jqXHR_iss_index_json.securitycollections.data;
      // 0: "id"
      // 1: "name"
      // 2: "title"
      // 3: "security_group_id"
      $.each( data, function( i, val ) {
        var accordion = $("#" + prefix_accordion + prefix_securitygroup + val[columns.indexOf("security_group_id")] + postfix_securitycollections); // accordion-securitygroup-{id}-securitycollections
        create_card(
          prefix_securitycollection + val[columns.indexOf("id")],  
          (accordion.find(".card").length + 1) + ". " + "<b>Коллекция: </b><span class='search'>" + val[columns.indexOf("title")] + "</span>", 
          "text-left mob-accordion-lev-5 index-security"
        ).appendTo(accordion);
      });
    }
    function create_iss_index_securitytypes_cards () {
      var map     = map_jqXHR_iss_index_json_securitytypes_data;
      var columns = jqXHR_iss_index_json.securitytypes.columns;
      // columns: Array(6)
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "security_type_name"
      // 5: "security_type_title"
      map.forEach( function( arr, key ) {
        var engine = get_iss_index_engine_by_id(key);
        var accordion = $("#" + prefix_accordion + prefix_engine + engine.id + postfix_securitytypes);
        var index = 1;
        $.each( arr, function( i, val ) {
          columns.indexOf("market_title");
          create_card(
            prefix_securitytype + val[columns.indexOf("id")],           // 
            index + ". <span class='search'>" + val[columns.indexOf("security_type_title")] + "</span>", 
            "text-left mob-accordion-lev-3"
          ).appendTo(accordion);
          index = index + 1;
        });
      });
    }


    function table_fill_with_iss_securities_aggr_by_emitent_id(table, table_securities) {
      if (arr_pages_jqXHR_iss_securities_json.length == 0) {
        alert("ERROR (" + table.table.attr("id") + "): iss_securities array is empty")
        return false;
      }
      if (map_aggr_by_emitent_id_jqXHR_iss_securities.size == 0) {
        alert("ERROR (" + table.table.attr("id") + "): iss_securities map aggregated by emitent_id is empty");
        return false;
      }
      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
                            // DO NOT ORDER BY SECID - it will trash the results with not traded securities
        'orderable_false' : [arr_pages_jqXHR_iss_securities_json[0].securities.columns.indexOf("secid")], 
        'order'           : [[arr_pages_jqXHR_iss_securities_json[0].securities.columns.indexOf("marketprice_boardid") + 1, 'desc']],
        'visible_false'   : []
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // lengthMenu : [[10, 25, 50, -1], [10, 25, 50, "All"]]
        // lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
        // lengthMenu : [[20, 10, 50, 100], [20, 10, 50, 100]]
        lengthMenu : [[10, 15, 20, 25, 30, 50, 100], [10, 15, 20, 25, 30, 50, 100]]
      }

      // COLUMNS - START
      var data_columns = new Array();

      // since columns description is missing (not available in https://iss.moex.com/iss/securities/columns)
      // translating here:
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[0]   }); // 0: "id"
      data_columns.push({ title : "Код ценной бумаги"                                            }); // 1: "secid"
      data_columns.push({ title : "Краткое наименование ценной бумаги"                           }); // 2: "shortname"
      data_columns.push({ title : "Регистрационный номер"                                        }); // 3: "regnumber"
      data_columns.push({ title : "Наименование финансового инструмента"                         }); // 4: "name"
      data_columns.push({ title : "Код ISIN"                                                     }); // 5: "isin"
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[6]   }); // 6: "is_traded"
      data_columns.push({ title : "Код эмитента"                                                 }); // 7: "emitent_id"
      data_columns.push({ title : "Наименование эмитента"                                        }); // 8: "emitent_title"
      data_columns.push({ title : "ИНН эмитента"                                                 }); // 9: "emitent_inn"
      data_columns.push({ title : "ОКПО эмитента"                                                }); // 10: "emitent_okpo"
      data_columns.push({ title : "Номер государственной регистрации"                            }); // 11: "gosreg"
      data_columns.push({ title : "Актив: Тип"                                                   }); // 12: "type"
      data_columns.push({ title : "Актив: Группа"                                                }); // 13: "group"
      data_columns.push({ title : "Режим торгов: основной"                                       }); // 14: "primary_boardid"
      data_columns.push({ title : "Режим торгов: ценообразующий"                                 }); // 15: "marketprice_boardid"
      data_columns.push({ title : "Кол-во выпускаемых ценных бумаг"                              }); // (no match - added below)
      // COLUMNS - END

      // DATA - START
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      var args = new Array();
      
      var first = null;
      map_aggr_by_emitent_id_jqXHR_iss_securities.forEach( function (value, key) {
        var arr = value.arr.slice();
        arr[0].push(value.size);         // (no match - added here)
        //console.log(arr);
        // skipping the first array
        if (!first) { first = arr; return; }
        args.push(arr);
      });

      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      // https://www.w3schools.com/jsref/jsref_concat_array.asp
      var data_raw = first.concat(...args);
      var data_arr = data_raw;

      // DATA - END

      // https://datatables.net/examples/data_sources/js_array
      var data = { 
        'data'    : data_arr,
        'columns' : data_columns
      }
      var header = $("<h5/>", {'class':"text-center", 'html': "Список эмитентов ценных бумаг"});
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf, data);

      var columns = arr_pages_jqXHR_iss_securities_json[0].securities.columns;
      // 0: "id"
      // 1: "secid"
      // 2: "shortname"
      // 3: "regnumber"
      // 4: "name"
      // 5: "isin"
      // 6: "is_traded"
      // 7: "emitent_id"
      // 8: "emitent_title"
      // 9: "emitent_inn"
      // 10: "emitent_okpo"
      // 11: "gosreg"
      // 12: "type"
      // 13: "group"
      // 14: "primary_boardid"
      // 15: "marketprice_boardid"

      var tohide = [
        columns.indexOf("id"),
        columns.indexOf("secid"),
        columns.indexOf("shortname"),
        columns.indexOf("regnumber"),
        columns.indexOf("name"),
        columns.indexOf("isin"),
        columns.indexOf("is_traded"),
        // 7: "emitent_id"
        // 8: "emitent_title"
        // 9: "emitent_inn"
        // 10: "emitent_okpo"
        columns.indexOf("gosreg"),
        columns.indexOf("type"),
        columns.indexOf("group"),
        columns.indexOf("primary_boardid"),
        columns.indexOf("marketprice_boardid"),
      ]

      function events(table) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_td = $(tr).find("td");

          if (arr_td.length == 0) return;

          // events
          $(tr).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(tr).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(tr).on('click', function (e) {
            $("#" + table_securities.table.attr("id") + postfix_DataTables_filter).find("input").val($(arr_td[columns.indexOf("emitent_inn")]).text())
            $("#" + table_securities.table.attr("id") + postfix_DataTables_filter).find("input").mouseup()
          });
        })
      }
      function google(table) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_th = $(tr).find("th");
          arr_th.each(function (i, th) {
            grid_create_img_google($(th), true);
          })

          var arr_td = $(tr).find("td");
          arr_td.each(function (i, td) {
            grid_create_img_google($(td), true);
          })
        })
      }

      table_hide_columns(table, tohide);
      events(table);
      //color (table, columns);
      google(table);

      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        table_hide_columns(table, tohide);
        events(table);
        //color (table, columns);
        google(table);
      });

      // https://datatables.net/extensions/scroller/examples/initialisation/simple.html
      table.table.css("white-space", "nowrap");
      table.table.css("max-width", table.cell.width());
    }
    function table_fill_with_iss_securities(table) {

      if (arr_pages_jqXHR_iss_securities_json.length == 0) {
        alert("ERROR (" + table.table.attr("id") + "): iss_securities array is empty")
        return false;
      }

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
                                // DO NOT ORDER BY SECID - it will trash the results with not traded securities
        'orderable_false' : [], // [arr_pages_jqXHR_iss_securities_json[0].securities.columns.indexOf("secid")], 
        'order'           : [], //[[arr_pages_jqXHR_iss_securities_json[0].securities.columns.indexOf("secid"), 'asc']],
        'visible_false'   : []
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // lengthMenu : [[10, 25, 50, -1], [10, 25, 50, "All"]]
        // lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
        // lengthMenu : [[20, 10, 50, 100], [20, 10, 50, 100]]
        lengthMenu : [[10, 15, 20, 25, 30, 50, 100], [10, 15, 20, 25, 30, 50, 100]]
      }

      // COLUMNS - START
      var data_columns = new Array();
      // $.each(arr_pages_jqXHR_iss_securities_json[0].securities.columns, function (i, val) {
      //  columns.push({ title : val});
      // })

      // since columns description is missing (not available in https://iss.moex.com/iss/securities/columns)
      // translating here:
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[0]   }); // 0: "id"
      data_columns.push({ title : "Код ценной бумаги"                                            }); // 1: "secid"
      data_columns.push({ title : "Краткое наименование ценной бумаги"                           }); // 2: "shortname"
      data_columns.push({ title : "Регистрационный номер"                                        }); // 3: "regnumber"
      data_columns.push({ title : "Наименование финансового инструмента"                         }); // 4: "name"
      data_columns.push({ title : "Код ISIN"                                                     }); // 5: "isin"
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[6]   }); // 6: "is_traded"
      data_columns.push({ title : "Код эмитента"                                                 }); // 7: "emitent_id"
      data_columns.push({ title : "Наименование эмитента"                                        }); // 8: "emitent_title"
      data_columns.push({ title : "ИНН эмитента"                                                 }); // 9: "emitent_inn"
      data_columns.push({ title : "ОКПО эмитента"                                                }); // 10: "emitent_okpo"
      data_columns.push({ title : "Номер государственной регистрации"                            }); // 11: "gosreg"
      data_columns.push({ title : "Актив: Тип"                                                   }); // 12: "type"
      data_columns.push({ title : "Актив: Группа"                                                }); // 13: "group"
      data_columns.push({ title : "Режим торгов: основной"                                       }); // 14: "primary_boardid"
      data_columns.push({ title : "Режим торгов: ценообразующий"                                 }); // 15: "marketprice_boardid"
      // adding columns for the original values (sync!)
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[12]  }); // (sync!) 12: "type"
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[13]  }); // (sync!) 13: "group"
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[14]  }); // (sync!) 14: "primary_boardid"
      data_columns.push({ title : arr_pages_jqXHR_iss_securities_json[0].securities.columns[15]  }); // (sync!) 15: "marketprice_boardid"
      // COLUMNS - END

      // DATA - START
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      var args = new Array();
      $.each(arr_pages_jqXHR_iss_securities_json, function (i, val) {
        https://stackoverflow.com/questions/4892282/each-index-start-number-in-jquery
        if (i === 0) return;            // skipping the first page
        args.push(val.securities.data);
      })
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      // https://www.w3schools.com/jsref/jsref_concat_array.asp
      var data_raw = arr_pages_jqXHR_iss_securities_json[0].securities.data.concat(...args);
      var columns = arr_pages_jqXHR_iss_securities_json[0].securities.columns;
      // 0: "id"
      // 1: "secid"
      // 2: "shortname"
      // 3: "regnumber"
      // 4: "name"
      // 5: "isin"
      // 6: "is_traded"
      // 7: "emitent_id"
      // 8: "emitent_title"
      // 9: "emitent_inn"
      // 10: "emitent_okpo"
      // 11: "gosreg"
      // 12: "type"
      // 13: "group"
      // 14: "primary_boardid"
      // 15: "marketprice_boardid"
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map
      var data_arr = data_raw.map( function (value) {
        var securitytype      = get_iss_index_securitytype_by_name  (value[columns.indexOf("type")]);
        var securitygroup     = get_iss_index_securitygroup_by_name (value[columns.indexOf("group")]);
        var board_primary     = get_iss_index_board_by_boardid      (value[columns.indexOf("primary_boardid")]);
        var board_marketprice = get_iss_index_board_by_boardid      (value[columns.indexOf("marketprice_boardid")]);

        var row = value.slice(); // copying current array

        // transforming
        if (securitytype)       { row[columns.indexOf("type")]  = securitytype.security_type_title; }
        if (securitygroup)      { row[columns.indexOf("group")] = securitygroup.title;              }
        if (board_primary)      { 
          var badges = "";
          if (board_primary.is_primary == 1) {
            var badge = $("<span/>", {
              'class': "badge badge-success",  
              'html' : "основной"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          if (board_primary.has_candles == 1) {
            var badge = $("<span/>", {
              'class': "badge badge-warning",  
              'html' : "свечи"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          if (board_primary.is_traded == 0) {
            var badge = $("<span/>", {
              'class': "badge badge-danger",  
              'html' : "закрыт"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          row[columns.indexOf("primary_boardid")]     = board_primary.board_title + badges;
        }
        if (board_marketprice)  { 
          var badges = "";
          if (board_marketprice.is_primary == 1) {
            var badge = $("<span/>", {
              'class': "badge badge-success",  
              'html' : "основной"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          if (board_marketprice.has_candles == 1) {
            var badge = $("<span/>", {
              'class': "badge badge-warning",  
              'html' : "свечи"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          if (board_marketprice.is_traded == 0) {
            var badge = $("<span/>", {
              'class': "badge badge-danger",  
              'html' : "закрыт"
            }).wrap('<p/>').parent().html();
            badges = badges + " " + badge;
          }
          row[columns.indexOf("marketprice_boardid")] = board_marketprice.board_title + badges;
        }

        row.push(value[columns.indexOf("type")]);                 // (sync!) 
        row.push(value[columns.indexOf("group")]);                // (sync!) 
        row.push(value[columns.indexOf("primary_boardid")]);      // (sync!) 
        row.push(value[columns.indexOf("marketprice_boardid")]);  // (sync!) 

        return row;
      }); 


      // https://stackoverflow.com/questions/41900798/javascript-how-group-and-sum-values-from-multidimensional-array
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce
      map_aggr_by_emitent_id_jqXHR_iss_securities = data_raw.reduce(function (accumulator, current_value) {
        if (current_value[columns.indexOf("emitent_id")]) {
          if (!accumulator.has(current_value[columns.indexOf("emitent_id")])) {
            accumulator.set(current_value[columns.indexOf("emitent_id")], { 
              arr   : new Array(current_value.slice()), // array with 1 element - array - this is for the further concat...
              size  : 1 
            });
          } else {
            var value = accumulator.get(current_value[columns.indexOf("emitent_id")]);
            value.size += 1;
            accumulator.set(current_value[columns.indexOf("emitent_id")], value);
          }
        }
        return accumulator;
      }, new Map());

      // DATA - END

      // https://datatables.net/examples/data_sources/js_array
      var data = { 
        'data'    : data_arr,
        'columns' : data_columns
      }
      var header = $("<h5/>", {'class':"text-center", 'html': "Список бумаг торгуемых на московской бирже"});
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf, data);

      columns = arr_pages_jqXHR_iss_securities_json[0].securities.columns;
      // 0: "id"
      // 1: "secid"
      // 2: "shortname"
      // 3: "regnumber"
      // 4: "name"
      // 5: "isin"
      // 6: "is_traded"
      // 7: "emitent_id"
      // 8: "emitent_title"
      // 9: "emitent_inn"
      // 10: "emitent_okpo"
      // 11: "gosreg"
      // 12: "type"
      // 13: "group"
      // 14: "primary_boardid"
      // 15: "marketprice_boardid"
      // adding columns for the original values (sync!)
      columns.push("orig_" + columns[12]); // (sync!)
      columns.push("orig_" + columns[13]); // (sync!)
      columns.push("orig_" + columns[14]); // (sync!)
      columns.push("orig_" + columns[15]); // (sync!)
      // 16: "orig_type"
      // 17: "orig_group"
      // 18: "orig_primary_boardid"
      // 19: "orig_marketprice_boardid"

      var tohide = [
        columns.indexOf("id"),
//      columns.indexOf("shortname"),
        columns.indexOf("regnumber"),       
        columns.indexOf("name"),
        columns.indexOf("isin"),            
        columns.indexOf("is_traded"),
        columns.indexOf("emitent_id"),      // now emitents are in a separate table  
        columns.indexOf("emitent_title"),      
//        columns.indexOf("emitent_inn"),   // now emitents are in a separate table
        columns.indexOf("emitent_okpo"),    
        columns.indexOf("gosreg"),          
        // adding columns for the original values (sync!)
        columns.indexOf("orig_" + columns[12]), // (sync!)
        columns.indexOf("orig_" + columns[13]), // (sync!)
        columns.indexOf("orig_" + columns[14]), // (sync!)
        columns.indexOf("orig_" + columns[15]), // (sync!)
      ]

      function color (table, columns) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_td = $(tr).find("td");
          if ( $(arr_td[columns.indexOf("is_traded")]).text() != "1" ) {
            $(arr_td[columns.indexOf("secid")]).css("color", "red");
          }
        })
      }

      function events(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // 12: "type"
          // 13: "group"
          // 14: "primary_boardid"
          // 15: "marketprice_boardid"
          var arr_td = $(tr).find("td");

          if (arr_td.length == 0) return;

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_td[columns.indexOf("secid")]).unbind();
          $(arr_td[columns.indexOf("secid")]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_td[columns.indexOf("secid")]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_td[columns.indexOf("secid")]).mouseup(function (e) { 
            var secid = $(this).text();
            process_event_click_secid(secid);
          });

/*
          // events
          $(arr_td[columns.indexOf("type")]).mouseup(function (e) { 
            //console.log($($(this).parent().find("td")[columns.indexOf("orig_" + "type")]).text());              // (sync!)
            var name = $($(this).parent().find("td")[columns.indexOf("orig_" + "type")]).text();                  // (sync!)
            var securitytype = get_iss_index_securitytype_by_name(name);
            if (securitytype) {
              //
            }
          });

          // events
          $(arr_td[columns.indexOf("group")]).mouseup(function (e) { 
            //console.log($($(this).parent().find("td")[columns.indexOf("orig_" + "group")]).text());             // (sync!)
            var name = $($(this).parent().find("td")[columns.indexOf("orig_" + "group")]).text();                 // (sync!)
            var securitygroup = get_iss_index_securitygroup_by_name(name);
            if (securitygroup) {
              //
            }
          });
*/

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_td[columns.indexOf("primary_boardid")]).unbind();
          $(arr_td[columns.indexOf("primary_boardid")]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_td[columns.indexOf("primary_boardid")]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_td[columns.indexOf("primary_boardid")]).mouseup(function (e) { 
            //console.log($($(this).parent().find("td")[columns.indexOf("orig_" + "primary_boardid")]).text());     // (sync!)
            var boardid = $($(this).parent().find("td")[columns.indexOf("orig_" + "primary_boardid")]).text();      // (sync!)
            var board_primary = get_iss_index_board_by_boardid(boardid);
            if (board_primary) {
              // columns: Array(9)
              // 0: "id"
              // 1: "board_group_id"
              // 2: "engine_id"
              // 3: "market_id"
              // 4: "boardid"
              // 5: "board_title"
              // 6: "is_traded"
              // 7: "has_candles"
              // 8: "is_primary"
              if (!is_mobile) {                                                                                  // for desktop tabs
                var a = $('.nav-tabs a[href="#' + prefix_collapse + prefix_engine + board_primary.engine_id + '"]')
                a.tab('show');
                a.on('shown.bs.tab', board(board_primary)); // events  
              } else {                                                                                                 // for mobile collapses
                // showing the engine collapse
                $("#" + prefix_collapse + prefix_engine + board_primary.engine_id).collapse("show");
              }
            }
          });

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_td[columns.indexOf("marketprice_boardid")]).unbind();
          $(arr_td[columns.indexOf("marketprice_boardid")]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_td[columns.indexOf("marketprice_boardid")]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_td[columns.indexOf("marketprice_boardid")]).mouseup(function (e) { 
            //console.log($($(this).parent().find("td")[columns.indexOf("orig_" + "marketprice_boardid")]).text()); // (sync!)
            var boardid = $($(this).parent().find("td")[columns.indexOf("orig_" + "marketprice_boardid")]).text();  // (sync!)
            var board_marketprice = get_iss_index_board_by_boardid(boardid);
            if (board_marketprice) {
              // columns: Array(9)
              // 0: "id"
              // 1: "board_group_id"
              // 2: "engine_id"
              // 3: "market_id"
              // 4: "boardid"
              // 5: "board_title"
              // 6: "is_traded"
              // 7: "has_candles"
              // 8: "is_primary"
              if (!is_mobile) {                                                                                      // for desktop tabs
                var a = $('.nav-tabs a[href="#' + prefix_collapse + prefix_engine + board_marketprice.engine_id + '"]')
                a.tab('show');
                a.on('shown.bs.tab', board(board_marketprice)); // events  
              } else {                                                                                                 // for mobile collapses
                // showing the engine collapse
                $("#" + prefix_collapse + prefix_engine + board_marketprice.engine_id).collapse("show");
              }
            }
          });

          function board(board) {
            // showing the engine's markets collapse
            $("#" + prefix_collapse + prefix_engine + board.engine_id + postfix_markets).collapse("show");
            // showing the market's collapse
            $("#" + prefix_collapse + prefix_market + board.market_id).collapse("show");
            // showing the market's boardgroups collapse
            $("#" + prefix_collapse + prefix_market + board.market_id + postfix_boardgroups).collapse("show");
            // showing the boardgroup's collapse
            $("#" + prefix_collapse + prefix_boardgroup + board.board_group_id).collapse("show");
            // showing the board's collapse
            $("#" + prefix_collapse + prefix_board + board.id).collapse("show");
            // scroll to the section
            var card_board = $("#" + prefix_collapse + prefix_board + board.id)
            // events
            card_board.on('shown.bs.collapse', function () {
              $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_board + board.id).offset().top}, 1000);
              // don't forget to remove this event listener so it's not firing up every time the card is shown
              card_board.unbind('shown.bs.collapse'); 
            })
            // doing this trick to make sure the tab is loaded and the correct offsets to scroll to are in place
            // trick: if the board tab is shown -> hide it and show again
            if (card_board.hasClass("show")) {
              card_board.collapse("hide");
              // events
              card_board.on('hidden.bs.collapse', function () { 
                card_board.collapse("show");
              });
            }
          }
        })
      }

      function google(table) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_th = $(tr).find("th");
          arr_th.each(function (i, th) {
            grid_create_img_google($(th), true);
          })

          var arr_td = $(tr).find("td");
          arr_td.each(function (i, td) {
            grid_create_img_google($(td), true);
          })
        })
      }

      table_hide_columns(table, tohide);
      events(table);
      color (table, columns);
      google(table);

      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        table_hide_columns(table, tohide);
        events(table);
        color (table, columns);
        google(table);
      });

      // https://datatables.net/extensions/scroller/examples/initialisation/simple.html
      table.table.css("white-space", "nowrap");
      table.table.css("max-width", table.cell.width());

      table_select(
        table, 
        $("#" + table.table.attr("id") + postfix_DataTables_filter),
        jqXHR_iss_index_json.securitytypes.data,
        jqXHR_iss_index_json.securitytypes.columns.indexOf("security_type_title"),
        "_securitytypes",
        "Актив - Тип: "
      );
      table_select(
        table, 
        $("#" + table.table.attr("id") + postfix_DataTables_filter),
        jqXHR_iss_index_json.securitygroups.data,
        jqXHR_iss_index_json.securitygroups.columns.indexOf("title"),
        "_securitygroups",
        "Актив - Группа: "
      );
      table_select(
        table, 
        $("#" + table.table.attr("id") + postfix_DataTables_filter),
        jqXHR_iss_index_json.boards.data,
        jqXHR_iss_index_json.boards.columns.indexOf("board_title"),
        "_boards",
        "Режим: "
      );
    }
    function table_fill_with_iss_board_securities_v2(table, id) {
      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      var embscs      = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).columns.securities;
      var embscm      = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).columns.marketdata;
      var securities  = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).securities.securities;
      var marketdata  = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).securities.marketdata;

      if (securities.data.length == 0) {
        console.log ("WARNING (" + table.table.attr("id") + "): securities are empty")
        return false;
      }

      if (marketdata.data.length == 0) {
        console.log ("WARNING (" + table.table.attr("id") + "): marketdata is empty")
        return false;
      }

      if (securities.data.length != marketdata.data.length) {
        alert (
          "ERROR (" + table.table.attr("id") + "): securities (length: " 
          + securities.data.length 
          + ") and marketdata (length: " 
          + marketdata.data.length 
          + ") doesn's match")
        return false;
      }

//    embscs.columns        embscm.columns      securities.columns        marketdata.columns
//    0: "id"               0: "id"             0: "SECID"                0: "SECID"
//    1: "name"             1: "name"           1: "BOARDID"              1: "BOARDID"
//    2: "short_title"      2: "short_title"    2: "SHORTNAME"            2: "BID"
//    3: "title"            3: "title"          3: "PREVPRICE"            3: "BIDDEPTH"
//    4: "is_ordered"       4: "is_ordered"     4: "LOTSIZE"              4: "OFFER"
//    5: "is_system"        5: "is_system"      5: "FACEVALUE"            5: "OFFERDEPTH"
//    6: "is_hidden"        6: "is_hidden"      6: "STATUS"               6: "SPREAD"
//    7: "trend_by"         7: "trend_by"       7: "BOARDNAME"            7: "BIDDEPTHT"
//    8: "is_signed"        8: "is_signed"      8: "DECIMALS"             8: "OFFERDEPTHT"
//    9: "has_percent"      9: "has_percent"    9: "SECNAME"              9: "OPEN"
//    10: "type"            10: "type"          10: "REMARKS"             10: "LOW"
//    11: "precision"       11: "precision"     11: "MARKETCODE"          11: "HIGH"
//    12: "is_linked"       12: "is_linked"     12: "INSTRID"             12: "LAST"
//                                              13: "SECTORID"            13: "LASTCHANGE"
//                                              14: "MINSTEP"             14: "LASTCHANGEPRCNT"
//                                              15: "PREVWAPRICE"         15: "QTY"
//                                              16: "FACEUNIT"            16: "VALUE"
//                                              17: "PREVDATE"            17: "VALUE_USD"
//                                              18: "ISSUESIZE"           18: "WAPRICE"
//                                              19: "ISIN"                19: "LASTCNGTOLASTWAPRICE"
//                                              20: "LATNAME"             20: "WAPTOPREVWAPRICEPRCNT"
//                                              21: "REGNUMBER"           21: "WAPTOPREVWAPRICE"
//                                              22: "PREVLEGALCLOSEPRICE" 22: "CLOSEPRICE"
//                                              23: "PREVADMITTEDQUOTE"   23: "MARKETPRICETODAY"
//                                              24: "CURRENCYID"          24: "MARKETPRICE"
//                                              25: "SECTYPE"             25: "LASTTOPREVPRICE"
//                                              26: "LISTLEVEL"           26: "NUMTRADES"
//                                              27: "SETTLEDATE"          27: "VOLTODAY"
//                                                                        28: "VALTODAY"
//                                                                        29: "VALTODAY_USD"
//                                                                        30: "ETFSETTLEPRICE"
//                                                                        31: "TRADINGSTATUS"
//                                                                        32: "UPDATETIME"
//                                                                        33: "ADMITTEDQUOTE"
//                                                                        34: "LASTBID"
//                                                                        35: "LASTOFFER"
//                                                                        36: "LCLOSEPRICE"
//                                                                        37: "LCURRENTPRICE"
//                                                                        38: "MARKETPRICE2"
//                                                                        39: "NUMBIDS"
//                                                                        40: "NUMOFFERS"
//                                                                        41: "CHANGE"
//                                                                        42: "TIME"
//                                                                        43: "HIGHBID"
//                                                                        44: "LOWOFFER"
//                                                                        45: "PRICEMINUSPREVWAPRICE"
//                                                                        46: "OPENPERIODPRICE"
//                                                                        47: "SEQNUM"
//                                                                        48: "SYSTIME"
//                                                                        49: "CLOSINGAUCTIONPRICE"
//                                                                        50: "CLOSINGAUCTIONVOLUME"
//                                                                        51: "ISSUECAPITALIZATION"
//                                                                        52: "ISSUECAPITALIZATION_UPDATETIME"
//                                                                        53: "ETFSETTLECURRENCY"
//                                                                        54: "VALTODAY_RUR"
      // COLUMNS - START
      var embscs_data_tr = array_2d_transpose(embscs.data);
      var embscs_names   = embscs_data_tr[embscs.columns.indexOf("name")]
      // console.log(embscs_names);
      var embscm_data_tr = array_2d_transpose(embscm.data);
      var embscm_names   = embscm_data_tr[embscm.columns.indexOf("name")]
      // console.log(embscm_names);
      var data_columns = new Array();
      // securities
      $.each(securities.columns, function (i, val) {
        // console.log("securities columns: " + val + " index in names: " + embscs_names.indexOf(val));
        if (embscs_names.indexOf(val) < 0) {
          data_columns.push({ title : val });
        } else {
          data_columns.push({ 
            title : embscs.data[embscs_names.indexOf(val)][embscs.columns.indexOf("title")] // putting detailed title for securities
          });
        }
      })
      // marketdata
      $.each(marketdata.columns, function (i, val) {
        // console.log("marketdata  columns: " + val + " index in names: " + embscm_names.indexOf(val))
        if (embscm_names.indexOf(val) < 0) {
          data_columns.push({ title : val });
        } else {
          data_columns.push({ 
            title : embscm.data[embscm_names.indexOf(val)][embscm.columns.indexOf("title")] // putting detailed title for marketdata
          });
        }
      })

      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();

      arr_datatable_order.push(new Array(securities.columns.length + marketdata.columns.indexOf("VALTODAY"), "desc"));
      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
        // lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
      }
      // COLUMNS - END

      // DATA - START
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map
      var data_arr = securities.data.map( function (value, index) {
        var row = value.slice(); // copying current array
        // transforming
        // expecting that securities and marketdata entries would match
        // if not - this is an error case
        row = row.concat(marketdata.data[index]);
        return row;
      }); 
      // DATA - END

      // https://datatables.net/examples/data_sources/js_array
      var data = { 
        'data'    : data_arr,
        'columns' : data_columns
      }

      var header = $("<h5/>", {'class':"text-center", 'html': "Таблица активов по режиму торгов: " + board.board_title });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      
      datatable_enable(table.table, datatable_conf, data);

      var tohide = [
        // securities
        securities.columns.indexOf("BOARDID"),
//        securities.columns.indexOf("SHORTNAME"),                            // fixed with columns.Adjust() : column is too broad with no reason
        securities.columns.indexOf("STATUS"),
        securities.columns.indexOf("BOARDNAME"),
        securities.columns.indexOf("DECIMALS"),
        securities.columns.indexOf("SECNAME"),
        securities.columns.indexOf("REMARKS"),
        securities.columns.indexOf("MARKETCODE"),
        securities.columns.indexOf("INSTRID"),
        securities.columns.indexOf("SECTORID"),
//        securities.columns.indexOf("ISIN"),                                 // showing this so the table is informative as possible
        securities.columns.indexOf("LATNAME"),
//        securities.columns.indexOf("REGNUMBER"),                            // showing this so the table is informative as possible
        securities.columns.indexOf("SECTYPE"),
        // marketdata
        securities.columns.length + marketdata.columns.indexOf("SECID"),      // duplicate from securities
        securities.columns.length + marketdata.columns.indexOf("BOARDID"), 
//        securities.columns.length + marketdata.columns.indexOf("SYSTIME"),  //  fixed with columns.Adjust() :  column is too broad with no reason
      ]

      function events(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // 12: "type"
          // 13: "group"
          // 14: "primary_boardid"
          // 15: "marketprice_boardid"
          var arr_td = $(tr).find("td");

          if (arr_td.length == 0) return;

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_td[securities.columns.indexOf("SECID")]).unbind();
          $(arr_td[securities.columns.indexOf("SECID")]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_td[securities.columns.indexOf("SECID")]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_td[securities.columns.indexOf("SECID")]).mouseup(function (e) { 
            var secid = $(this).text();
            process_event_click_secid(secid);
          });
        });
      }

      function color (table) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_th = $(tr).find("th");
          var arr_td = $(tr).find("td");

          // head
          for(var i = securities.columns.length; i < arr_th.length; i++) {
            $(arr_th[i]).css("background-color", "aliceblue");
            // https://www.w3schools.com/jquery/event_hover.asp
            $(arr_th[i]).hover(
              function() { $(this).css("background-color", "lightblue"); },     // in
              function() { $(this).css("background-color", "aliceblue"); }      // out
            );
          }

          // body
          for(var i = securities.columns.length; i < arr_td.length; i++) {
            $(arr_td[i]).css("background-color", "aliceblue");
            // https://www.w3schools.com/jquery/event_hover.asp
            $(arr_td[i]).hover(
              function() { $(this).css("background-color", "lightblue"); },     // in
              function() { $(this).css("background-color", "aliceblue"); }      // out
            );
          }
        })
      }

      // adding question info
      function google(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // head
          $(tr).find("th").each( function (i, th) {
            grid_create_img_google($(th), true);
          });
          // body
          var td = $(tr).find("td")[securities.columns.indexOf("SECID")];
          grid_create_img_google($(td), true);
        })
      }

      //!!!
      // https://getbootstrap.com/docs/4.4/utilities/overflow/
      table.cell.addClass("overflow-auto");
      
      table_hide_columns(table, tohide, true);
      google(table);
      color (table);
      events(table);
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        table_hide_columns(table, tohide);
        google(table);
        color (table);
        events(table);
      });
      return table;
    }
    function table_fill_with_iss_board_securities(table, id) {
      var securities    = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).securities.securities;
      var embsc_data    = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).columns.securities.data
      var embsc_columns = map_board_jqXHR_iss_engines_markets_boards_securities_json.get(id).columns.securities.columns;
      // embtc_columns
      // columns: Array(13)
      // 0: "id"
      // 1: "name"
      // 2: "short_title"
      // 3: "title"
      // 4: "is_ordered"
      // 5: "is_system"
      // 6: "is_hidden"
      // 7: "trend_by"
      // 8: "is_signed"
      // 9: "has_percent"
      // 10: "type"
      // 11: "precision"
      // 12: "is_linked"

      var embsc_data_tr     = array_2d_transpose(embsc_data);
      var real_names_order  = embsc_data_tr[embsc_columns.indexOf("name")]
      // console.log(real_names_order)
      // real_names_order
      // 0: "SECID"
      // 1: "BOARDID"
      // 2: "SHORTNAME"
      // 3: "PREVPRICE"
      // 4: "LOTSIZE"
      // 5: "FACEVALUE"
      // 6: "STATUS"
      // 7: "BOARDNAME"
      // 8: "DECIMALS"
      // 9: "SECNAME"
      // 10: "REMARKS"
      // 11: "MARKETCODE"
      // 12: "INSTRID"
      // 13: "SECTORID"
      // 14: "MINSTEP"
      // 15: "PREVWAPRICE"
      // 16: "FACEUNIT"
      // 17: "PREVDATE"
      // 18: "ISSUESIZE"
      // 19: "ISIN"
      // 20: "LATNAME"
      // 21: "REGNUMBER"
      // 22: "PREVLEGALCLOSEPRICE"
      // 23: "PREVADMITTEDQUOTE"
      // 24: "CURRENCYID"
      // 25: "SECTYPE"
      // 26: "LISTLEVEL"
      // 27: "SETTLEDATE"


      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      //securities.columns
      // columns: Array(36)
      // 0: "SECID"
      // 1: "BOARDID"
      // 2: "BOARDNAME"
      // 3: "PREVWAPRICE"
      // 4: "YIELDATPREVWAPRICE"
      // 5: "COUPONVALUE"
      // 6: "NEXTCOUPON"
      // 7: "ACCRUEDINT"
      // 8: "PREVPRICE"
      // 9: "LOTSIZE"
      // 10: "FACEVALUE"
      // 11: "STATUS"
      // 12: "MATDATE"
      // 13: "DECIMALS"
      // 14: "COUPONPERIOD"
      // 15: "ISSUESIZE"
      // 16: "PREVLEGALCLOSEPRICE"
      // 17: "PREVADMITTEDQUOTE"
      // 18: "PREVDATE"
      // 19: "SECNAME"
      // 20: "REMARKS"
      // 21: "MARKETCODE"
      // 22: "INSTRID"
      // 23: "SECTORID"
      // 24: "MINSTEP"
      // 25: "FACEUNIT"
      // 26: "CURRENCYID"
      // 27: "BUYBACKPRICE"
      // 28: "BUYBACKDATE"
      // 29: "ISIN"
      // 30: "LATNAME"
      // 31: "REGNUMBER"
      // 32: "SHORTNAME"
      // 33: "LISTLEVEL"
      // 34: "SECTYPE"
      // 35: "SETTLEDATE"

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();
      var i_datatable = 0;

      embsc_data[real_names_order.indexOf("SECID"    )][embsc_columns.indexOf("short_title")] = "Актив";
      embsc_data[real_names_order.indexOf("SECID"    )][embsc_columns.indexOf("title")]       = "Актив";

      var thead = $("<thead/>");
      var tr = $("<tr/>")

      table_th(embsc_data[real_names_order.indexOf("SECID"                )][embsc_columns.indexOf("title")], 'right').appendTo(tr);
        arr_datatable_order.push(new Array(i_datatable, "asc"));
        i_datatable = i_datatable + 1;

      //!!! rotation of the header to vertical
      // https://stackoverflow.com/questions/24335274/how-to-rotate-text-vertically-at-table-column-header
      // https://datatables.net/forums/discussion/37252/rotated-table-headers
      // var div = $("<div/>", {'class' : "rotate", 'html' : embsc_data[real_names_order.indexOf("SECNAME"              )][embsc_columns.indexOf("title")]}).wrap('<p/>').parent().html();
      // table_th(div, 'center').appendTo(tr);

      table_th(embsc_data[real_names_order.indexOf("SECNAME"              )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("PREVPRICE"            )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("PREVLEGALCLOSEPRICE"  )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("PREVADMITTEDQUOTE"    )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("LOTSIZE"              )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("CURRENCYID"           )][embsc_columns.indexOf("title")], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("FACEVALUE"            )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;
      table_th(embsc_data[real_names_order.indexOf("FACEUNIT"             )][embsc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;

      if (!is_mobile) {
        //table_th(itc_data[it_columns.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }
      //var hidden_id = table.table.attr('id') + "-ID";
      //table_th(hidden_id, 'left', hidden_id).appendTo(tr);
      //  i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
        // lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( securities.data , function( i, value ) {
        var head = value[securities.columns.indexOf("SECID")];
        if (value[securities.columns.indexOf("STATUS")] != "A") {
          head = "<font color='red'>" + head + "</font>" 
        }
        var data = [
          { data: value[securities.columns.indexOf("SECNAME")],             id: null },
          { data: value[securities.columns.indexOf("PREVPRICE")],           id: null },
          { data: value[securities.columns.indexOf("PREVLEGALCLOSEPRICE")], id: null },
          { data: value[securities.columns.indexOf("PREVADMITTEDQUOTE")],   id: null },
          { data: value[securities.columns.indexOf("LOTSIZE")],             id: null },
          { data: value[securities.columns.indexOf("CURRENCYID")],          id: null },
          { data: value[securities.columns.indexOf("FACEVALUE")],           id: null },
          { data: value[securities.columns.indexOf("FACEUNIT")],            id: null },
          //{ data: (Math.round(value[securities.columns.indexOf("PRICE")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          //{ data: (Math.round(value[securities.columns.indexOf("QUANTITY")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          //{ data: (Math.round(value[securities.columns.indexOf("VALUE")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[it_columns.indexOf("UPDATETIME")]);
        }
        //data.push({ data: val[it_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);
      
      var header = $("<h5/>", {'class':"text-center", 'html': "Таблица активов по режиму торгов: " + board.board_title });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);

      //!!!
      // https://getbootstrap.com/docs/4.4/utilities/overflow/
      table.cell.addClass("overflow-auto");

/*
      $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none");   // hiding ID column
      table.table.on( 'draw.dt', function () {
        $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none"); // hiding ID column
      });
      // events
      tbody.on('click', 'tr', function (e) {
        // console.log($(e.currentTarget).find("#id").text());
        var id = parseInt($(e.currentTarget).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          //alert( 'You clicked on ' + id);
          if (!is_mobile) {                                                                                        // for desktop tabs
            $('.nav-tabs a[href="#' + prefix_collapse + prefix_engine + id + '"]').tab('show');  
          } else {                                                                                                 // for mobile collapses
            // showing the engine collapse
            $("#" + prefix_collapse + prefix_engine + id).collapse("show");
            $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_engine + id).offset().top}, 1000);
          }
        }
      });
*/
      return table;
    }
    function table_fill_with_iss_board_trades_v2(table, id) {
      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      if (!map_board_jqXHR_iss_engines_markets_boards_trades_json.has(id)) {
        alert ("ERROR (" + table.table.attr("id") + "): no trades data received for board: " + id);
        return false;
      }

      var trades  = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).trades.trades;
      if (trades === undefined || trades.data.length == 0) {
        console.log ("WARNING (" + table.table.attr("id") + "): 0 trades records available for board: " + id);
        return false;
      }
      var embtc   = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades;
//        embtc.columns       trades.columns
//        0: "id"             0: "TRADENO"
//        1: "name"           1: "TRADETIME"
//        2: "short_title"    2: "BOARDID"
//        3: "title"          3: "SECID"
//        4: "is_ordered"     4: "PRICE"
//        5: "is_system"      5: "QUANTITY"
//        6: "is_hidden"      6: "VALUE"
//        7: "trend_by"       7: "PERIOD"
//        8: "is_signed"      8: "TRADETIME_GRP"
//        9: "has_percent"    9: "SYSTIME"
//        10: "type"          10: "BUYSELL"
//        11: "precision"     11: "DECIMALS"
//        12: "is_linked"

      // COLUMNS - START
      var embtc_data_tr = array_2d_transpose(embtc.data);
      var embtc_names   = embtc_data_tr[embtc.columns.indexOf("name")]

      // this is to make sure the title is short
      if (embtc_names.indexOf("TRADETIME") >= 0 ) {
        embtc.data[embtc_names.indexOf("TRADETIME")][embtc.columns.indexOf("title")]   = embtc.data[embtc_names.indexOf("TRADETIME" )][embtc.columns.indexOf("short_title")];
      }
      if (embtc_names.indexOf("BUYSELL") >= 0 ) {
        embtc.data[embtc_names.indexOf("BUYSELL"  )][embtc.columns.indexOf("title")]   = embtc.data[embtc_names.indexOf("BUYSELL"   )][embtc.columns.indexOf("short_title")];
      }
      // these ones changed in multiple places - search the code!!!
      embtc.data[embtc_names.indexOf("SECID")][embtc.columns.indexOf("short_title")] = "Актив";
      embtc.data[embtc_names.indexOf("SECID")][embtc.columns.indexOf("title")]       = "Актив";

      var data_columns = new Array();
      // trades
      $.each(trades.columns, function (i, val) {
        // console.log("trades columns: " + val + " index in names: " + embtc_names.indexOf(val));
        if (embtc_names.indexOf(val) < 0) {
          data_columns.push({ title : val });
        } else {
          data_columns.push({ 
            title : embtc.data[embtc_names.indexOf(val)][embtc.columns.indexOf("title")] // putting detailed title for trades
          });
        }
      })

      if (trades.columns.indexOf("BUYSELL") >= 0) {
        data_columns.push({ title : "BUYSELL"});  // (sync!) - trades.columns
      }

      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
        // lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
        lengthMenu : [[10, 15, 20, 25, 30, 50, 100], [10, 15, 20, 25, 30, 50, 100]]
      }

      // COLUMNS - END

      // DATA - START
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map

      var data_arr = trades.data.map( function (value) {
        var row = value.slice(); // copying current array

        // transforming
        if (trades.columns.indexOf("BUYSELL") >= 0) {
          switch (row[trades.columns.indexOf("BUYSELL")]) {
            case "S":
              row[trades.columns.indexOf("BUYSELL")] = "Продажа"
              break;
            case "B":
              row[trades.columns.indexOf("BUYSELL")] = "Покупка"
              break;
            default:
              row[trades.columns.indexOf("BUYSELL")] = "Неопределено"
              break;
          }
          row.push(value[trades.columns.indexOf("BUYSELL")]) // (sync!) - trades.columns
        }
        return row;
      });
      // DATA - END

      // https://datatables.net/examples/data_sources/js_array
      var data = { 
        'data'    : data_arr,
        'columns' : data_columns
      }

      var header = $("<h5/>", {'class':"text-center", 'html': 
        "Все сделки по режиму торгов: " 
        + board.board_title 
        + " ("
        + trades.data[0][trades.columns.indexOf("SYSTIME")]
        + ")"
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf, data);

      if (trades.columns.indexOf("BUYSELL") >= 0) {
        trades.columns.push("orig_" + "BUYSELL")  // (sync!) - trades.columns
      }
      var tohide = [
        // trades
        trades.columns.indexOf("BOARDID"),
        trades.columns.indexOf("PERIOD"),         // S - before 10:00:00
                                                  // N -  after 10:00:00
        
        trades.columns.indexOf("TRADETIME_GRP"),  // ...
                                                  // 959  - 09:59:58
                                                  // 959  - 09:59:59
                                                  // 1000 - 10:00:00
                                                  // 1000 - 10:00:01
                                                  // ...
        trades.columns.indexOf("SYSTIME"),
        trades.columns.indexOf("DECIMALS"),
        //
        (trades.columns.indexOf("BUYSELL") >= 0) ? trades.columns.indexOf("orig_" + "BUYSELL") : -1, // (sync!) - trades.columns
      ]

      function events(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // 12: "type"
          // 13: "group"
          // 14: "primary_boardid"
          // 15: "marketprice_boardid"
          var arr_td = $(tr).find("td");

          if (arr_td.length == 0) return;

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_td[trades.columns.indexOf("SECID")]).unbind();
          $(arr_td[trades.columns.indexOf("SECID")]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_td[trades.columns.indexOf("SECID")]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_td[trades.columns.indexOf("SECID")]).mouseup(function (e) { 
            var secid = $(this).text();
            process_event_click_secid(secid);
          });
        });
      }

      function color (table) {
        $(table.table).find("tr").each( function (i, tr) {
          var arr_td = $(tr).find("td");
          if (trades.columns.indexOf("BUYSELL") >= 0) {
            //console.log($(arr_td[trades.columns.indexOf("orig_" + "BUYSELL")]).text());
            switch ($(arr_td[trades.columns.indexOf("orig_" + "BUYSELL")]).text()) { // (sync!) - trades.columns
              case "S":
                $(arr_td[trades.columns.indexOf("BUYSELL")]).css("color", "red")
                break;
              case "B":
                $(arr_td[trades.columns.indexOf("BUYSELL")]).css("color", "green")
                break;
              default:
                break;
            }
          }
        })
      }

      // adding question info
      function google(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // head
          $(tr).find("th").each( function (i, th) {
            grid_create_img_google($(th), true);
          });
          // body
          var td = $(tr).find("td")[trades.columns.indexOf("SECID")];
          grid_create_img_google($(td), true);
        })
      }

      //!!!
      // https://getbootstrap.com/docs/4.4/utilities/overflow/
      table.cell.addClass("overflow-auto");

      table_hide_columns(table, tohide, true);
      google(table);
      color (table);
      events(table);
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        table_hide_columns(table, tohide);
        google(table);
        color (table);
        events(table);
      });


      return table;
    }
    function table_fill_with_iss_board_trades(table, id) {
      //console.log(jqXHR_iss_turnovers_json.turnovers.data);
      //console.log(jqXHR_iss_turnovers_json.turnovers.columns);
      //console.log(jqXHR_iss_turnovers_columns_json.turnovers.data);
      //console.log(jqXHR_iss_turnovers_columns_json.turnovers.columns);
      var trades      = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).trades.trades;

      var embtc_data    = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.data
      var embtc_columns = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.columns;
      // embtc_columns
      // 0: "id"
      // 1: "name"
      // 2: "short_title"
      // 3: "title"
      // 4: "is_ordered"
      // 5: "is_system"
      // 6: "is_hidden"
      // 7: "trend_by"
      // 8: "is_signed"
      // 9: "has_percent"
      // 10: "type"
      // 11: "precision"
      // 12: "is_linked"

      var embtc_data_tr     = array_2d_transpose(embtc_data);
      var real_names_order  = embtc_data_tr[embtc_columns.indexOf("name")]
      // real_names_order
      // 0: "TRADENO"
      // 1: "TRADETIME"
      // 2: "SECID"
      // 3: "PRICE"
      // 4: "QUANTITY"
      // 5: "PERIOD"
      // 6: "VALUE"
      // 7: "YIELD"
      // 8: "BOARDID"
      // 9: "SYSTIME"
      // 10: "ACCRUEDINT"
      // 11: "REPORATE"
      // 12: "REPOVALUE"
      // 13: "REPO2VALUE"
      // 14: "REPOTERM"
      // 15: "DECIMALS"

      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      //for (var [key, value] of aggregates) {
        // trades.columns
        // columns: Array(18)
        // 0: "TRADENO"
        // 1: "TRADETIME"
        // 2: "BOARDID"
        // 3: "SECID"
        // 4: "PRICE"
        // 5: "QUANTITY"
        // 6: "VALUE"
        // 7: "PERIOD"
        // 8: "YIELD"
        // 9: "TRADETIME_GRP"
        // 10: "SYSTIME"
        // 11: "BUYSELL"
        // 12: "ACCRUEDINT"
        // 13: "REPORATE"
        // 14: "REPOVALUE"
        // 15: "REPO2VALUE"
        // 16: "REPOTERM"
        // 17: "DECIMALS"
        // data[0].push(value[trades.columns.indexOf(sort_by)]);
        // data[1].push(value[trades.columns.indexOf("SECID")]);
      //}

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();
      var i_datatable = 0;

      embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("short_title")] = "Актив";
      embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("title")]       = "Актив";

      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(embtc_data[real_names_order.indexOf("TRADETIME"    )][embtc_columns.indexOf("short_title")], 'right').appendTo(tr);
        arr_datatable_order.push(new Array(i_datatable, "asc"));
        i_datatable = i_datatable + 1;

      table_th(embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;

      // BUYSELL is missing - hardcoding the title
      table_th("Операция", 'left').appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(embtc_data[real_names_order.indexOf("PRICE"    )][embtc_columns.indexOf("title")], 'left').appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(embtc_data[real_names_order.indexOf("QUANTITY" )][embtc_columns.indexOf("short_title")], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(embtc_data[real_names_order.indexOf("VALUE"    )][embtc_columns.indexOf("short_title")], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;
      
      if (!is_mobile) {
        //table_th(itc_data[it_columns.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }

      //var hidden_id = table.table.attr('id') + "-ID";
      //table_th(hidden_id, 'left', hidden_id).appendTo(tr);
      //  i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
        // https://datatables.net/examples/advanced_init/length_menu.html
        // "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
        lengthMenu : [[25, 10, 50, 100], [25, 10, 50, 100]],
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( trades.data , function( i, value ) {
        var head = value[trades.columns.indexOf("TRADETIME")];
        var data = [
          { data: value[trades.columns.indexOf("SECID")], id: null },
          { data: value[trades.columns.indexOf("BUYSELL")] == "B" ? "<font color='green'>Покупка</font>":"<font color='red'>Продажа</font>", id: null },
          { data: (Math.round(value[trades.columns.indexOf("PRICE")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(value[trades.columns.indexOf("QUANTITY")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(value[trades.columns.indexOf("VALUE")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[it_columns.indexOf("UPDATETIME")]);
        }
        //data.push({ data: val[it_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);
      
      var header = $("<h5/>", {'class':"text-center", 'html': 
        "Все сделки по режиму торгов: " 
        + board.board_title 
        + " ("
        + trades.data[trades.data.length - 1][trades.columns.indexOf("SYSTIME")]
        + ")"
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);
/*
      $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none");   // hiding ID column
      table.table.on( 'draw.dt', function () {
        $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none"); // hiding ID column
      });
      // events
      tbody.on('click', 'tr', function (e) {
        // console.log($(e.currentTarget).find("#id").text());
        var id = parseInt($(e.currentTarget).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          //alert( 'You clicked on ' + id);
          if (!is_mobile) {                                                                                        // for desktop tabs
            $('.nav-tabs a[href="#' + prefix_collapse + prefix_engine + id + '"]').tab('show');  
          } else {                                                                                                 // for mobile collapses
            // showing the engine collapse
            $("#" + prefix_collapse + prefix_engine + id).collapse("show");
            $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_engine + id).offset().top}, 1000);
          }
        }
      });
*/
      return table;
    }
    function table_fill_with_iss_board_trades_aggr_by_secid(table, id) {
      table.table.attr("id");

      if (!map_board_jqXHR_iss_engines_markets_boards_trades_json.has(id)) {
        alert ("ERROR (" + table.table.attr("id") + "): no trades data received for board: " + id);
        return false;
      }

      var trades      = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).trades.trades;
      if (trades === undefined || trades.data.length == 0) {
        console.log ("WARNING (" + table.table.attr("id") + "): 0 trades records available for board: " + id);
        return false;
      }

      if ((trades.columns.indexOf("VALUE") < 0) && (trades.columns.indexOf("QUANTITY") < 0)){
        console.log ("WARNING (" + table.table.attr("id") + "): both VALUE and QUANTITY columns are missing in trades for board: " + id);
        return false;
      }
      var aggregates  = map_aggr_by_SECID_jqXHR_iss_engines_markets_boards_trades;
      if (aggregates.length == 0) {
        console.log ("WARNING (" + table.table.attr("id") + "): 0 securities aggregated for board: " + id);
        return false;
      }

      var embtc_data    = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.data
      var embtc_columns = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.columns;
      // embtc_columns
      // 0: "id"
      // 1: "name"
      // 2: "short_title"
      // 3: "title"
      // 4: "is_ordered"
      // 5: "is_system"
      // 6: "is_hidden"
      // 7: "trend_by"
      // 8: "is_signed"
      // 9: "has_percent"
      // 10: "type"
      // 11: "precision"
      // 12: "is_linked"

      var embtc_data_tr     = array_2d_transpose(embtc_data);
      var real_names_order  = embtc_data_tr[embtc_columns.indexOf("name")]
      // real_names_order
      // 0: "TRADENO"
      // 1: "TRADETIME"
      // 2: "SECID"
      // 3: "PRICE"
      // 4: "QUANTITY"
      // 5: "PERIOD"
      // 6: "VALUE"
      // 7: "YIELD"
      // 8: "BOARDID"
      // 9: "SYSTIME"
      // 10: "ACCRUEDINT"
      // 11: "REPORATE"
      // 12: "REPOVALUE"
      // 13: "REPO2VALUE"
      // 14: "REPOTERM"
      // 15: "DECIMALS"

      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();
      var i_datatable = 0;

      embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("short_title")] = "Актив";
      embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("title")]       = "Актив";

      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(embtc_data[real_names_order.indexOf("SECID"    )][embtc_columns.indexOf("title")], 'right').appendTo(tr);
        i_datatable = i_datatable + 1;

      if (trades.columns.indexOf("VALUE") >= 0) {
        table_th(embtc_data[real_names_order.indexOf("VALUE"    )][embtc_columns.indexOf("title")], 'left' ).appendTo(tr);
          arr_datatable_order.push(new Array(i_datatable, "desc"));
          i_datatable = i_datatable + 1;
      }

      if (trades.columns.indexOf("QUANTITY") >= 0) {
        table_th(embtc_data[real_names_order.indexOf("QUANTITY")][embtc_columns.indexOf("title")], 'left' ).appendTo(tr);
          i_datatable = i_datatable + 1;
      }
      if (!is_mobile) {
        //table_th(itc_data[it_columns.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }

      //var hidden_id = table.table.attr('id') + "-ID";
      //table_th(hidden_id, 'left', hidden_id).appendTo(tr);
      //  i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : true,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
      }

      // Body
      var tbody = $("<tbody/>")
      for (var [key, value] of aggregates) {
      //$.each( it_data, function( i, val ) {
        var head = value[trades.columns.indexOf("SECID")];
        var data = []
        if (trades.columns.indexOf("VALUE") >= 0) {
          data.push({ data: (Math.round(value[trades.columns.indexOf("VALUE")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null });
        }
        if (trades.columns.indexOf("QUANTITY") >= 0) {
          data.push({ data: (Math.round(value[trades.columns.indexOf("QUANTITY")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null });
        }
        if (!is_mobile) {
          //data.push(val[it_columns.indexOf("UPDATETIME")]);
        }
        //data.push({ data: val[it_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      }; //});
      tbody.appendTo(table.table);
      
      var header = $("<h5/>", {'class':"text-center", 'html': 
        "Агрегированные итоги торгов в режиме: " 
        + board.board_title 
        + " ("
        + trades.data[trades.data.length - 1][trades.columns.indexOf("SYSTIME")]
        + ")"
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);

      function events(table) {
        $(table.table).find("tr").each( function (i, tr) {
          // 12: "type"
          // 13: "group"
          // 14: "primary_boardid"
          // 15: "marketprice_boardid"
          var arr_th = $(tr).find("th");

          if (i == 0) return; // skipping the first header row;
          if (arr_th.length == 0) return;

          // events
          // Making sure we're not setting duplicate handlers
          $(arr_th[0]).unbind();
          $(arr_th[0]).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(arr_th[0]).hover(
            function() { $(this).css("background-color", "lightblue"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
          $(arr_th[0]).mouseup(function (e) { 
            var secid = $(this).text();
            process_event_click_secid(secid);
          });
        });
      }

      events(table);
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        events(table);
      });
      return table;
    }
    function table_fill_with_iss_market_turnovers(table, id) {
      var market = get_iss_index_market_by_id(id);
      //console.log(id);
      var emt_data     = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).turnovers.turnovers.data
      var emt_columns  = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).turnovers.turnovers.columns;
      var emtc_data    = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).columns.turnovers.data
      var emtc_columns = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).columns.turnovers.columns;

      var i_st = emtc_columns.indexOf("short_title")

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var i_datatable = 0;
      // emtc_columns
      // 0: "name"
      // 1: "short_title"
      // 2: "title"
      // 3: "is_ordered"
      // 4: "is_system"
      // 5: "is_hidden"
      // 6: "trend_by"
      // 7: "is_signed"
      // 8: "has_percent"
      // 9: "type"
      // 10: "precision"
      // 11: "alias"

      // emt_columns
      // 0: "NAME"          - not present
      // 1: "ID"            - not present
      // 2: "VALTODAY"      - real index 1
      // 3: "VALTODAY_USD"  - real index 2
      // 4: "NUMTRADES"     - real index 3
      // 5: "UPDATETIME"    - real index 4
      // 6: "TITLE"         - real index 5
      // 7: "BOARDID"       - real index 0

      var emtc_data_tr      = array_2d_transpose(emtc_data);
      var real_names_order  = emtc_data_tr[emtc_columns.indexOf("name")]
      // real_names_order
      // 0: "BOARDID"
      // 1: "VALTODAY"
      // 2: "VALTODAY_USD"
      // 3: "NUMTRADES"
      // 4: "UPDATETIME"
      // 5: "TITLE"
      
      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(emtc_data[real_names_order.indexOf("TITLE"       )][i_st], 'right').appendTo(tr);
        arr_datatable_orderable_false.push(i_datatable);
        i_datatable = i_datatable + 1;

      table_th(emtc_data[real_names_order.indexOf("VALTODAY"    )][i_st], 'left' ).appendTo(tr);
        arr_datatable_order.push(new Array(i_datatable, "desc"));
        i_datatable = i_datatable + 1;

      table_th(emtc_data[real_names_order.indexOf("VALTODAY_USD")][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(emtc_data[real_names_order.indexOf("NUMTRADES"   )][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;
      
      if (!is_mobile) {
        //table_th(emtc_data[real_names_order.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }
      
      // https://iss.moex.com/iss/engines/stock/markets/shares/turnovers
      var hidden_id = table.table.attr('id') + "-ID";
      table_th(hidden_id, 'left', hidden_id).appendTo(tr);
        i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = (emt_data.length > 20) ? { 'paging' : true } : { 'paging' : false };

      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( emt_data, function( i, val ) {
        var head = val[emt_columns.indexOf("TITLE")];
        var data = [
          { data: (Math.round(val[emt_columns.indexOf("VALTODAY")]     * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[emt_columns.indexOf("VALTODAY_USD")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[emt_columns.indexOf("NUMTRADES")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[emt_columns.indexOf("UPDATETIME")]);
        }
        data.push({ data: val[emt_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);

      var header = $("<h5/>", {
        'class':"text-center", 
        'html': market.title + ": Оборот по рынку на " + emt_data[0][emt_columns.indexOf("UPDATETIME")] 
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);

      $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none");   // hiding ID column
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none"); // hiding ID column
      });

      // color 
      tbody.find("tr").each(function (i, tr) {
        var id = parseInt($(tr).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          $(tr).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(tr).hover(
            function() { $(this).css("background-color", "lightgray"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
        }
      })

      // events
      tbody.on('click', 'tr', function (e) {
        // console.log($(e.currentTarget).find("#id").text());
        var id = parseInt($(e.currentTarget).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          var board = get_iss_index_board_by_id (id);
          // "id"
          // "board_group_id"
          // "engine_id"
          // "market_id"
          // "boardid"
          // "board_title"
          // "is_traded"
          // "has_candles"
          // "is_primary"

          // showing the engine's markets collapse
          $("#" + prefix_collapse + prefix_engine + board.engine_id + postfix_markets).collapse("show");
          // showing the market's collapse
          $("#" + prefix_collapse + prefix_market + board.market_id).collapse("show");
          // showing the market's boardgroups collapse
          $("#" + prefix_collapse + prefix_market + board.market_id + postfix_boardgroups).collapse("show");
          // showing the boardgroup's collapse
          $("#" + prefix_collapse + prefix_boardgroup + board.board_group_id).collapse("show");
          // showing the board's collapse
          $("#" + prefix_collapse + prefix_board + board.id).collapse("show");
          // scroll to the section
          $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_board + board.id).offset().top}, 1000);
        }
      });

      return table;
    }
    function table_fill_with_iss_engine_turnoverssectors(table, id) {
      var engine = get_iss_index_engine_by_id(id);
      //console.log(id);
      var ets_data    = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.data
      var ets_columns = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.columns;
      var etc_data    = map_engine_jqXHR_iss_engines_turnovers_json.get(id).columns.turnovers.data
      var etc_columns = map_engine_jqXHR_iss_engines_turnovers_json.get(id).columns.turnovers.columns;

      var i_st = etc_columns.indexOf("short_title")

      if (map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.data.length === 0) {
        //console.log("--- (Table) TurnoversSectors data is empty for engine: " + engine.name);
        //console.log("Data for "+ engine.name + " engine: ");
        //console.log(map_engine_jqXHR_iss_engines_turnovers_json.get(id));
        return false;
      }

      // console.log(ets_data);
      // console.log(ets_columns);
      // console.log(etc_data);
      // console.log(etc_columns);
      // console.log(i_st);
      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var i_datatable = 0;

      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(etc_data[ets_columns.indexOf("TITLE"       ) - 1][i_st], 'right').appendTo(tr);  // - 1 to compensate on additional (index: 0) column SECTOR in turnoverssectors
        arr_datatable_orderable_false.push(i_datatable);
        i_datatable = i_datatable + 1;

      table_th(etc_data[ets_columns.indexOf("VALTODAY"    ) - 1][i_st], 'left' ).appendTo(tr);  // - 1 to compensate on additional (index: 0) column SECTOR in turnoverssectors
        arr_datatable_order.push(new Array(i_datatable, "desc"));
        i_datatable = i_datatable + 1;

      table_th(etc_data[ets_columns.indexOf("VALTODAY_USD") - 1][i_st], 'left' ).appendTo(tr);  // - 1 to compensate on additional (index: 0) column SECTOR in turnoverssectors
        i_datatable = i_datatable + 1;

      table_th(etc_data[ets_columns.indexOf("NUMTRADES"   ) - 1][i_st], 'left' ).appendTo(tr);  // - 1 to compensate on additional (index: 0) column SECTOR in turnoverssectors
        i_datatable = i_datatable + 1;
      
      if (!is_mobile) {
        //table_th(etc_data[ets_columns.indexOf("UPDATETIME") - 1][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : false,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': false,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( ets_data, function( i, val ) {
        var head = val[ets_columns.indexOf("TITLE")];
        var data = [
          { data: (Math.round(val[ets_columns.indexOf("VALTODAY")]     * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[ets_columns.indexOf("VALTODAY_USD")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[ets_columns.indexOf("NUMTRADES")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[ets_columns.indexOf("UPDATETIME")]);
        }
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);

      var header = $("<h5/>", {
        'class':"text-center", 
        'html': engine.title + ": Секторы на " + ets_data[0][ets_columns.indexOf("UPDATETIME")] 
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);
      return table;
    }
    function table_fill_with_iss_engine_turnovers(table, id) {
      var engine = get_iss_index_engine_by_id(id);
      //console.log(id);
      var et_data     = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnovers.data
      var et_columns  = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnovers.columns;
      var etc_data    = map_engine_jqXHR_iss_engines_turnovers_json.get(id).columns.turnovers.data
      var etc_columns = map_engine_jqXHR_iss_engines_turnovers_json.get(id).columns.turnovers.columns;

      // var it_data     = jqXHR_iss_turnovers_json.turnovers.data;
      // var it_columns  = jqXHR_iss_turnovers_json.turnovers.columns;
      // var itc_data    = jqXHR_iss_turnovers_columns_json.turnovers.data;
      // var itc_columns = jqXHR_iss_turnovers_columns_json.turnovers.columns;

      var i_st = etc_columns.indexOf("short_title")

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var i_datatable = 0;

      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(etc_data[et_columns.indexOf("TITLE"       )][i_st], 'right').appendTo(tr);
        arr_datatable_orderable_false.push(i_datatable);
        i_datatable = i_datatable + 1;

      table_th(etc_data[et_columns.indexOf("VALTODAY"    )][i_st], 'left' ).appendTo(tr);
        arr_datatable_order.push(new Array(i_datatable, "desc"));
        i_datatable = i_datatable + 1;

      table_th(etc_data[et_columns.indexOf("VALTODAY_USD")][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(etc_data[et_columns.indexOf("NUMTRADES"   )][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;
      
      if (!is_mobile) {
        //table_th(etc_data[et_columns.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }

      var hidden_id = table.table.attr('id') + "-ID";
      table_th(hidden_id, 'left', hidden_id).appendTo(tr);
        i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : false,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': true,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( et_data, function( i, val ) {
        var head = val[et_columns.indexOf("TITLE")];
        var data = [
          { data: (Math.round(val[et_columns.indexOf("VALTODAY")]     * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[et_columns.indexOf("VALTODAY_USD")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[et_columns.indexOf("NUMTRADES")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[et_columns.indexOf("UPDATETIME")]);
        }
        data.push({ data: val[et_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);

      var header = $("<h5/>", {
        'class':"text-center", 
        'html': engine.title + ": Обороты торговой сессии по рынкам на " + et_data[0][et_columns.indexOf("UPDATETIME")] 
      });
      header.css("padding", "10px");
      header.css("margin", "0px");
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);

      $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none");   // hiding ID column
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none"); // hiding ID column
      });

      // color 
      tbody.find("tr").each(function (i, tr) {
        var id = parseInt($(tr).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          $(tr).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(tr).hover(
            function() { $(this).css("background-color", "lightgray"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
        }
      })

      // events
      tbody.on('click', 'tr', function (e) {
        // console.log($(e.currentTarget).find("#id").text());
        var id = parseInt($(e.currentTarget).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          var market = get_iss_index_market_by_id(id);
          // showing the engine's markets collapse
          $("#" + prefix_collapse + prefix_engine + market.trade_engine_id + postfix_markets).collapse("show");
          // showing the market's collapse
          $("#" + prefix_collapse + prefix_market + market.id).collapse("show");
          // scroll to the section
          $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_market + market.id).offset().top}, 1000);
        }
      });

      return table;
    }
    function table_fill_with_iss_index_turnovers(table) {
      //console.log(jqXHR_iss_turnovers_json.turnovers.data);
      //console.log(jqXHR_iss_turnovers_json.turnovers.columns);
      //console.log(jqXHR_iss_turnovers_columns_json.turnovers.data);
      //console.log(jqXHR_iss_turnovers_columns_json.turnovers.columns);

      var it_data     = jqXHR_iss_turnovers_json.turnovers.data;
      var it_columns  = jqXHR_iss_turnovers_json.turnovers.columns;
      var itc_data    = jqXHR_iss_turnovers_columns_json.turnovers.data;
      var itc_columns = jqXHR_iss_turnovers_columns_json.turnovers.columns;

      var i_st = itc_columns.indexOf("short_title")

      // Head
      var arr_datatable_orderable_false = new Array();
      var arr_datatable_order           = new Array();
      var arr_datatable_visible_false   = new Array();
      var i_datatable = 0;

      var thead = $("<thead/>");
      var tr = $("<tr/>")
      table_th(itc_data[it_columns.indexOf("TITLE"       )][i_st], 'right').appendTo(tr);
        arr_datatable_orderable_false.push(i_datatable);
        i_datatable = i_datatable + 1;

      table_th(itc_data[it_columns.indexOf("VALTODAY"    )][i_st], 'left' ).appendTo(tr);
        arr_datatable_order.push(new Array(i_datatable, "desc"));
        i_datatable = i_datatable + 1;

      table_th(itc_data[it_columns.indexOf("VALTODAY_USD")][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;

      table_th(itc_data[it_columns.indexOf("NUMTRADES"   )][i_st], 'left' ).appendTo(tr);
        i_datatable = i_datatable + 1;
      
      if (!is_mobile) {
        //table_th(itc_data[it_columns.indexOf("UPDATETIME")][i_st], 'left' ).appendTo(tr);
        //  i_datatable = i_datatable + 1;
      }

      var hidden_id = table.table.attr('id') + "-ID";
      table_th(hidden_id, 'left', hidden_id).appendTo(tr);
        i_datatable = i_datatable + 1;

      tr.appendTo(thead);
      thead.appendTo(table.table);

      // DataTable configuration:
      // https://mdbootstrap.com/docs/jquery/tables/sort/
      var sort = {
        'ordering'        : true,
        'orderable_false' : arr_datatable_orderable_false,
        'order'           : arr_datatable_order,
        'visible_false'   : arr_datatable_visible_false
      }
      // https://mdbootstrap.com/docs/jquery/tables/pagination/
      var pagination = {
        'paging' : false,
      }
      // https://mdbootstrap.com/docs/jquery/tables/search/
      var search = {
        'searching': false,
      }
      var datatable_conf = {
        sort       : sort,
        pagination : pagination,
        search     : search,
      }

      // Body
      var tbody = $("<tbody/>")
      $.each( it_data, function( i, val ) {
        var head = val[it_columns.indexOf("TITLE")];
        var data = [
          { data: (Math.round(val[it_columns.indexOf("VALTODAY")]     * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[it_columns.indexOf("VALTODAY_USD")] * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
          { data: (Math.round(val[it_columns.indexOf("NUMTRADES")]    * 1000) / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), id: null },
        ]
        if (!is_mobile) {
          //data.push(val[it_columns.indexOf("UPDATETIME")]);
        }
        data.push({ data: val[it_columns.indexOf("ID")], id: hidden_id }); // hidden
        table_tr(head, data).appendTo(tbody);
      });
      tbody.appendTo(table.table);
      
      var header = $("<h5/>", {'class':"text-center", 'html': "Сводные обороты на " + it_data[0][it_columns.indexOf("UPDATETIME")] });
      header.css("padding", "10px")
      header.css("margin", "0px")
      header.     appendTo(table.cell);
      table.table.appendTo(table.cell);
      datatable_enable(table.table, datatable_conf);

      $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none");   // hiding ID column
      // https://datatables.net/reference/event/draw
      table.table.on( 'draw.dt', function () {
        $("#" + table.table.attr('id') + " #" + hidden_id).css("display","none"); // hiding ID column
      });

      // color 
      tbody.find("tr").each(function (i, tr) {
        var id = parseInt($(tr).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          $(tr).css("background-color", "beige");
          // https://www.w3schools.com/jquery/event_hover.asp
          $(tr).hover(
            function() { $(this).css("background-color", "lightgray"); }, // in
            function() { $(this).css("background-color", "beige");   }    // out
          );
        }
      })

      // events
      tbody.on('click', 'tr', function (e) {
        // console.log($(e.currentTarget).find("#id").text());
        var id = parseInt($(e.currentTarget).find("#" + hidden_id).text());
        if (!isNaN(id)) {
          //alert( 'You clicked on ' + id);
          if (!is_mobile) {                                                                                        // for desktop tabs
            $('.nav-tabs a[href="#' + prefix_collapse + prefix_engine + id + '"]').tab('show');  
          } else {                                                                                                 // for mobile collapses
            // showing the engine collapse
            $("#" + prefix_collapse + prefix_engine + id).collapse("show");
            $('html, body').animate({scrollTop: $("#" + prefix_card + prefix_engine + id).offset().top}, 1000);
          }
        }
      });

      return table;
    }

    function chart_create_mixed_bar_line_iss_securities_security_board_candles(canvas, secid, boardid, interval) {
      var board = get_iss_index_board_by_boardid(boardid);          //      board from: https://iss.moex.com/iss/index
      if (!board) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no data available for board: " + boardid);
        return false;
      }
      if (!map_secid_jqXHR_iss_securities_security_json.has(secid)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no data received for security: " + secid);
        return false;
      }
      var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
      if (!map.has(map_key_security_candles)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid);
        return false;
      }
      if (!map.get(map_key_security_candles).has(boardid)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid + " for board: " + boardid);
        return false;
      }
      if (!map.get(map_key_security_candles).get(boardid).has(interval)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid + " for board: " + boardid + " for interval: " + interval);
        return false;
      }
      var arr_candles = map.get(map_key_security_candles).get(boardid).get(interval);
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      var args = new Array();
      var first = null;
      $.each(arr_candles, function (i, candles) {
        var arr = candles.candles.data.slice();
        if (!first) { first = arr; return; }
        args.push(arr);
      })

      //console.log(arr_candles);
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      // https://www.w3schools.com/jsref/jsref_concat_array.asp
      var data_raw = first.concat(...args);
      var data_arr = array_2d_transpose(data_raw);
      //console.log(data_arr); 

      var labels_arr = data_arr[arr_candles[0].candles.columns.indexOf("end")].map( function (value) {
        // console.log(moment(value).toDate());
        // transforming
        return moment(value).toDate();
      });

      var info = {
        datasets : [
          {
            // https://stackoverflow.com/questions/38085352/how-to-use-two-y-axes-in-chart-js-v2
            yAxisID: "volume",
            data  : data_arr[arr_candles[0].candles.columns.indexOf("volume")],//.slice(0, 6),
            label : "объём",
            // chroma.brewer.OrRd
            // (9) ["#fff7ec", "#fee8c8", "#fdd49e", "#fdbb84", "#fc8d59", "#ef6548", "#d7301f", "#b30000", "#7f0000"]
            backgroundColor: chroma("#d7301f").hex(),
            borderColor: 'white',
            //borderWidth: 2,
            order: 2,
          },
          {
            // https://stackoverflow.com/questions/38085352/how-to-use-two-y-axes-in-chart-js-v2
            yAxisID: "close",
            data  : data_arr[arr_candles[0].candles.columns.indexOf("close")],//.slice(0, 6),
            label : "закрытие",
            type  : 'line',
            // https://stackoverflow.com/questions/46194039/how-to-change-size-of-point-in-chartjs
            pointRadius: 1,
            pointHoverRadius: 1,
            backgroundColor: 'white',
            // chroma.scale(['#fafa6e','#2A4858']).mode('lch').colors(6)
            // (6) ["#fafa6e", "#9cdf7c", "#4abd8c", "#00968e", "#106e7c", "#2a4858"]
            borderColor: chroma("#2a4858").alpha(0.6).hex(),
            borderWidth: 2,
            order: 1,
            fill: false,
          }
        ],

        labels: labels_arr,//.slice(0, 6),
        title: {
          display: true,
          text: board.board_title,
        },
        ///////////
        scales: {
          xAxes: [{
            type: 'time',
            // https://www.chartjs.org/docs/latest/axes/cartesian/time.html
            time: {
              parser: 'MM/DD/YYYY HH:mm',
              // round: 'day'
              tooltipFormat: 'll HH:mm'
            },
            scaleLabel: {
              display: true,
              labelString: 'Date'
            },
            ticks: {
              maxRotation: 0
            }
          }],
          yAxes: [{
            id: 'volume',
            type: 'linear',
            position: 'right',
          }, {
            id: 'close',
            type: 'linear',
            position: 'left',
          }]
        },
      }
      //chartjs_zoom_test(canvas.canvas);
      chartjs_create_mixed_bar_line(canvas.canvas, info);
      return canvas;
    }
    function chart_create_candlestick_iss_securities_security_board_candles(canvas, secid, boardid, interval) {
      var board = get_iss_index_board_by_boardid(boardid);          //      board from: https://iss.moex.com/iss/index
      if (!board) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no data available for board: " + boardid);
        return false;
      }
      if (!map_secid_jqXHR_iss_securities_security_json.has(secid)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no data received for security: " + secid);
        return false;
      }
      var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
      if (!map.has(map_key_security_candles)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid);
        return false;
      }
      if (!map.get(map_key_security_candles).has(boardid)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid + " for board: " + boardid);
        return false;
      }
      if (!map.get(map_key_security_candles).get(boardid).has(interval)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no candles data available for security: " + secid + " for board: " + boardid + " for interval: " + interval);
        return false;
      }
      var arr_candles = map.get(map_key_security_candles).get(boardid).get(interval);
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      var args = new Array();
      var first = null;
      $.each(arr_candles, function (i, candles) {
        var arr = candles.candles.data.slice();
        if (!first) { first = arr; return; }
        args.push(arr);
      })

      //console.log(arr_candles);
      // https://stackoverflow.com/questions/1316371/converting-an-array-to-a-function-arguments-list
      // https://www.w3schools.com/jsref/jsref_concat_array.asp
      var data_raw = first.concat(...args);
      var data_arr = data_raw.map( function (row) {
        // 0: "open"
        // 1: "close"
        // 2: "high"
        // 3: "low"
        // 4: "value"
        // 5: "volume"
        // 6: "begin"
        // 7: "end"

        // TODO: add volume bar : https://github.com/chartjs/chartjs-chart-financial/issues/14
        var value = {
          t: ( new Date( row[arr_candles[0].candles.columns.indexOf("end")].replace(/\s/, "T") ) ).getTime(),
          o: row[arr_candles[0].candles.columns.indexOf("open")],
          h: row[arr_candles[0].candles.columns.indexOf("high")],
          l: row[arr_candles[0].candles.columns.indexOf("low")],
          c: row[arr_candles[0].candles.columns.indexOf("close")],
        }; 
        // transforming
        return value;
      }); 
      //console.log(data_arr); 

      var info = { 
        datasets : [{
          data  : data_arr,
          label : board.board_title,
        }]
      }

      chartjs_create_candlestick(canvas.canvas, info);
      return canvas;
    }
    function chart_create_doughnut_iss_board_trades_aggr_by_secid(canvas, id, palette, sort_by) {
      if (!map_board_jqXHR_iss_engines_markets_boards_trades_json.has(id)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no trades data received for board: " + id);
        return false;
      }

      var trades      = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).trades.trades;
      if (trades === undefined || trades.data.length == 0) {
        console.log ("WARNING (" + canvas.canvas.attr("id") + "): 0 trades records available for board: " + id);
        return false;
      }

      if (trades.columns.indexOf(sort_by) < 0) {
        console.log ("WARNING (" + canvas.canvas.attr("id") + "): no SORT BY column (" + sort_by + ") available in trades for board: " + id);
        return false;
      }

      var aggregates  = map_aggr_by_SECID_jqXHR_iss_engines_markets_boards_trades;
      if (aggregates.length == 0) {
        console.log ("WARNING (" + canvas.canvas.attr("id") + "): 0 securities aggregated for board: " + id);
        return false;
      }

      var embtc_data    = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.data
      var embtc_columns = map_board_jqXHR_iss_engines_markets_boards_trades_json.get(id).columns.trades.columns;
      // embtc_columns
      // 0: "id"
      // 1: "name"
      // 2: "short_title"
      // 3: "title"
      // 4: "is_ordered"
      // 5: "is_system"
      // 6: "is_hidden"
      // 7: "trend_by"
      // 8: "is_signed"
      // 9: "has_percent"
      // 10: "type"
      // 11: "precision"
      // 12: "is_linked"

      var embtc_data_tr     = array_2d_transpose(embtc_data);
      var real_names_order  = embtc_data_tr[embtc_columns.indexOf("name")]
      // real_names_order
      // 0: "TRADENO"
      // 1: "TRADETIME"
      // 2: "SECID"
      // 3: "PRICE"
      // 4: "QUANTITY"
      // 5: "PERIOD"
      // 6: "VALUE"
      // 7: "YIELD"
      // 8: "BOARDID"
      // 9: "SYSTIME"
      // 10: "ACCRUEDINT"
      // 11: "REPORATE"
      // 12: "REPOVALUE"
      // 13: "REPO2VALUE"
      // 14: "REPOTERM"
      // 15: "DECIMALS"
      // console.log(embtc_data[real_names_order.indexOf(sort_by)][embtc_columns.indexOf("short_title")])
      var sort_by_title = embtc_data[real_names_order.indexOf(sort_by)][embtc_columns.indexOf("short_title")];

      var board = get_iss_index_board_by_id(id);
      // "id"
      // "board_group_id"
      // "engine_id"
      // "market_id"
      // "boardid"
      // "board_title"
      // "is_traded"
      // "has_candles"
      // "is_primary"

      // https://stackoverflow.com/questions/37982476/how-to-sort-a-map-by-value-in-javascript
      aggregates[Symbol.iterator] = function* () {
          // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/yield*
          yield* [...this.entries()].sort(
            (a, b) => 
              b[1][trades.columns.indexOf(sort_by)] - a[1][trades.columns.indexOf(sort_by)]
              //console.log(a, b)
          );
      }
      // console.log("-------");
      // for (var [key, value] of aggregates) {     // get data sorted
      //   console.log(key + ' ' + value);
      // }
      // console.log(aggregates);
      // console.log([...aggregates]);              // sorted order
      // console.log([...aggregates.entries()]);    // original insertation order

      var data = new Array(new Array(), new Array());
      var index = 0;
      for (var [key, value] of aggregates) {     // get data sorted
        index += 1;
        if (index > 20) { break; } // we need only TOP-20
        // columns: Array(18)
        // 0: "TRADENO"
        // 1: "TRADETIME"
        // 2: "BOARDID"
        // 3: "SECID"
        // 4: "PRICE"
        // 5: "QUANTITY"
        // 6: "VALUE"
        // 7: "PERIOD"
        // 8: "YIELD"
        // 9: "TRADETIME_GRP"
        // 10: "SYSTIME"
        // 11: "BUYSELL"
        // 12: "ACCRUEDINT"
        // 13: "REPORATE"
        // 14: "REPOVALUE"
        // 15: "REPO2VALUE"
        // 16: "REPOTERM"
        // 17: "DECIMALS"
        data[0].push(value[trades.columns.indexOf(sort_by)]);
        data[1].push(value[trades.columns.indexOf("SECID")]);
      }

      var units = null;
      if (sort_by == "VALUE")     {units = ['руб.', 'тыс. руб.', 'млн. руб.']}
      if (sort_by == "QUANTITY")  {units = ['лотов', 'тыс. лотов', 'млн. лотов']}
      
      var datasets = [{
          data: data[0],
          comment: sort_by, // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'end',
            //align:  'top',
            formatter: function(value, ctx) {
              return fbn(value, units);
            }
          }
      }];

      var labels = data[1];
      var title = ["Топ-20 инструментов (" + sort_by_title + "): " + board.board_title];

      var info = {datasets : datasets, labels : labels, title : title}
      chartjs_create_doughnut(canvas.canvas, info);

      return canvas;
    }    
    function chart_create_doughnut_iss_market_turnovers(canvas, id, palette) {

      var market     = get_iss_index_market_by_id(id);

      if (!map_market_jqXHR_iss_engines_markets_turnovers_json.get(id)) {
        alert ("ERROR (" + canvas.canvas.attr("id") + "): no turnovers data received for market: " + id);
        return false;
      }

      var large      = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).turnovers.turnovers.data.length > 20;

      if (large) { palette = 4; }

      //console.log(id);
      //console.log(map_market_jqXHR_iss_engines_markets_turnovers_json);
      //console.log(map_market_jqXHR_iss_engines_markets_turnovers_json.get(id));
      // 0: "NAME"
      // 1: "ID"
      // 2: "VALTODAY"
      // 3: "VALTODAY_USD"
      // 4: "NUMTRADES"
      // 5: "UPDATETIME"
      // 6: "TITLE"
      // 7: "BOARDID"
      var data_each  = new Array()
      var data_total = new Array()
      var columns = map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).turnovers.turnovers.columns;
      $.each( map_market_jqXHR_iss_engines_markets_turnovers_json.get(id).turnovers.turnovers.data, function( i, val ) {
        if (val[columns.indexOf("ID")] !== null) { 
          if (large) {
            if ((val[columns.indexOf("VALTODAY")] == 0)     &&
                (val[columns.indexOf("VALTODAY_USD")] == 0) &&
                (val[columns.indexOf("NUMTRADES")] == 0)
            ) {
              return;
            }
          }
          data_each.push(val); 
        }
        else { 
          data_total.push(val); 
        }
      });

      if (data_each.length === 0) {
        console.log ("WARNING (" + canvas.canvas.attr("id") + "): turnovers data is empty for market: " + id);
        //console.log("--- (Chart) Turnovers data is empty for market: " + market.name);
        //console.log("Data for "+ market.name + " market: ");
        //console.log(map_market_jqXHR_iss_engines_markets_turnovers_json.get(id));
        return false;
      }

      var data    = array_2d_transpose(data_each);

      if (data[columns.indexOf("VALTODAY")].isNull()     ||
          data[columns.indexOf("VALTODAY_USD")].isNull() ||
          data[columns.indexOf("NUMTRADES")].isNull()) {
        //console.log("--- (Chart) Turnovers are Null array for market: " + market.name);
        //console.log("Column indexes checked: " 
        //  + columns.indexOf("VALTODAY") + ", " + 
        //  + columns.indexOf("VALTODAY_USD") + ", " + 
        //  + columns.indexOf("NUMTRADES") + " Data: ");
        //console.log(data);
        return false;
      }

      var datasets = [{
          data: data[columns.indexOf("VALTODAY")],
          comment: "VALTODAY", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'top',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. руб.', 'млрд. руб.', 'трлн. руб.']);
            }
          }
      },{
          data: data[columns.indexOf("VALTODAY_USD")],
          comment: "VALTODAY_USD", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'bottom',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. $', 'млрд. $', 'трлн. $']);
            }
          }
      },{
          data: data[columns.indexOf("NUMTRADES")],
          comment: "NUMTRADES", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'right',
            formatter: function(value, ctx) {
              return fbn(value, ['штук', 'тыс. штук', 'млн. штук']);
            }
          }
      }];

      var labels = data[columns.indexOf("TITLE")];
      var title = [market.title + ": Оборот по рынку на " + data[columns.indexOf("UPDATETIME")][0]];

      var info = {datasets : datasets, labels : labels, title : title}
      chartjs_create_doughnut(canvas.canvas, info);
      return canvas;
    }
    function chart_create_doughnut_iss_engine_turnoverssectors(canvas, id, palette) {
      var engine     = get_iss_index_engine_by_id(id);
      var columns = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.columns;

      if (map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.data.length === 0) {
        //console.log("--- (Chart) TurnoversSectors data is empty for engine: " + engine.name);
        //console.log("Data for "+ engine.name + " engine: ");
        //console.log(map_engine_jqXHR_iss_engines_turnovers_json.get(id));
        return false;
      }

      var data    = array_2d_transpose(map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnoverssectors.data);

      if (data[columns.indexOf("VALTODAY")].isNull()     ||
          data[columns.indexOf("VALTODAY_USD")].isNull() ||
          data[columns.indexOf("NUMTRADES")].isNull()) {
        // console.log("--- (Chart) TurnoversSectors are Null array for engine: " + engine.name);
        // console.log("Column indexes checked: " 
        //   + columns.indexOf("VALTODAY") + ", " + 
        //   + columns.indexOf("VALTODAY_USD") + ", " + 
        //   + columns.indexOf("NUMTRADES") + " Data: ");
        // console.log(data);
        return false;
      }

      var datasets = [{
          data: data[columns.indexOf("VALTODAY")],
          comment: "VALTODAY", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'top',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. руб.', 'млрд. руб.', 'трлн. руб.']);
            }
          }
      },{
          data: data[columns.indexOf("VALTODAY_USD")],
          comment: "VALTODAY_USD", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'bottom',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. $', 'млрд. $', 'трлн. $']);
            }
          }
      },{
          data: data[columns.indexOf("NUMTRADES")],
          comment: "NUMTRADES", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'right',
            formatter: function(value, ctx) {
              return fbn(value, ['штук', 'тыс. штук', 'млн. штук']);
            }
          }
      }];

      var labels = data[columns.indexOf("TITLE")];
      var title = [engine.title + ":", "Секторы на " + data[columns.indexOf("UPDATETIME")][0]];

      var info = {datasets : datasets, labels : labels, title : title}
      chartjs_create_doughnut(canvas.canvas, info);
      return canvas;
    }
    function chart_create_doughnut_iss_engine_turnovers(canvas, id, palette) {
      var data_each  = new Array()
      var data_total = new Array()
      var engine     = get_iss_index_engine_by_id(id);
      //console.log(id);
      //console.log(map_engine_jqXHR_iss_engines_turnovers_json);
      //console.log(map_engine_jqXHR_iss_engines_turnovers_json.get(id));
      var columns = map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnovers.columns;
      $.each( map_engine_jqXHR_iss_engines_turnovers_json.get(id).turnovers.turnovers.data, function( i, val ) {
        if (val[columns.indexOf("ID")] !== null) 
          { data_each.push(val); }
        else
          { data_total.push(val); }
      });

      if (data_each.length === 0) {
        //console.log("--- (Chart) Turnovers data is empty for engine: " + engine.name);
        //console.log("Data for "+ engine.name + " engine: ");
        //console.log(map_engine_jqXHR_iss_engines_turnovers_json.get(id));
        return false;
      }

      var data    = array_2d_transpose(data_each);

      if (data[columns.indexOf("VALTODAY")].isNull()     ||
          data[columns.indexOf("VALTODAY_USD")].isNull() ||
          data[columns.indexOf("NUMTRADES")].isNull()) {
        //console.log("--- (Chart) Turnovers are Null array for engine: " + engine.name);
        //console.log("Column indexes checked: " 
        //  + columns.indexOf("VALTODAY") + ", " + 
        //  + columns.indexOf("VALTODAY_USD") + ", " + 
        //  + columns.indexOf("NUMTRADES") + " Data: ");
        //console.log(data);
        return false;
      }

      var datasets = [{
          data: data[columns.indexOf("VALTODAY")],
          comment: "VALTODAY", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'top',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. руб.', 'млрд. руб.', 'трлн. руб.']);
            }
          }
      },{
          data: data[columns.indexOf("VALTODAY_USD")],
          comment: "VALTODAY_USD", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'bottom',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. $', 'млрд. $', 'трлн. $']);
            }
          }
      },{
          data: data[columns.indexOf("NUMTRADES")],
          comment: "NUMTRADES", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[palette],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'right',
            formatter: function(value, ctx) {
              return fbn(value, ['штук', 'тыс. штук', 'млн. штук']);
            }
          }
      }];

      var labels = data[columns.indexOf("TITLE")];
      var title = [engine.title + ":", "Обороты торговой сессии по рынкам на " + data[columns.indexOf("UPDATETIME")][0]];

      var info = {datasets : datasets, labels : labels, title : title}
      chartjs_create_doughnut(canvas.canvas, info);
      return canvas;
    }
    function chart_create_doughnut_iss_index_turnovers(canvas) {
      var data_each  = new Array()
      var data_total = new Array()

      var columns = jqXHR_iss_turnovers_json.turnovers.columns;
      $.each( jqXHR_iss_turnovers_json.turnovers.data, function( i, val ) {
        if (val[columns.indexOf("ID")] !== null) 
          { data_each.push(val); }
        else
          { data_total.push(val); }
      });

      var data    = array_2d_transpose(data_each);
      var columns = jqXHR_iss_turnovers_json.turnovers.columns;
      var datasets = [{
          data: data[columns.indexOf("VALTODAY")],
          comment: "VALTODAY", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[0],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'top',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. руб.', 'млрд. руб.', 'трлн. руб.']);
            }
          }
      },{
          data: data[columns.indexOf("VALTODAY_USD")],
          comment: "VALTODAY_USD", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[0],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'bottom',
            formatter: function(value, ctx) {
              return fbn(value, ['млн. $', 'млрд. $', 'трлн. $']);
            }
          }
      },{
          data: data[columns.indexOf("NUMTRADES")],
          comment: "NUMTRADES", // custom field which will be available in e.g. tooltips: { callbacks: { ... }} 
          backgroundColor: backgroundColor[0],
          datalabels: {
            // see: https://chartjs-plugin-datalabels.netlify.app/guide/positioning.html#alignment-and-offset
            anchor: 'center',
            align:  'right',
            formatter: function(value, ctx) {
              return fbn(value, ['штук', 'тыс. штук', 'млн. штук']);
            }
          }
      }];

      var labels = data[columns.indexOf("TITLE")];
      // multiple rows
      // var title = ["Сводные обороты по рынкам",  "на " + data[columns.indexOf("UPDATETIME")][0]];
      var title = "Сводные обороты по рынкам на " + data[columns.indexOf("UPDATETIME")][0];

      var info = {datasets : datasets, labels : labels, title : title}
      chartjs_create_doughnut(canvas.canvas, info);
      return canvas;
    }


    function grid_create_nav_return(cell, title, target, collapses) {
      // https://icons.getbootstrap.com/
      // https://icons.getbootstrap.com/icons/
      // https://icons.getbootstrap.com/icons/arrow-90deg-up/
      // https://icons.getbootstrap.com/#usage
      var img = $("<img/>",  {
        'src'    : '{% static "moex/node_modules/icons-master/icons/arrow-90deg-up.svg" %}', 
        'alt'    : "",
        'width'  : "16", 
        'height' : "16",
      });
      img.css('display', "inline");
      img.css('vertical-align', "text-top");
      // https://getbootstrap.com/docs/4.0/components/navs/#base-nav
      var ul = $("<ul/>",  {'class' : "nav"});
      var li = $("<li/>",  {'class' : "nav-item"});
      var a  = $("<a/>",   {'class' : "nav-link", 'href' : "javascript:void(0)", 'html' : " " + title});
      a.css('display',      "inline");
      a.css('padding', "0px");
      a.css('padding-left', "4px");
      img.appendTo(li)
        a.appendTo(li);
       li.appendTo(ul);
      a.on('click', function (e) {
        // showing the collapses
        $.each(collapses, function (i, val){
          $(val).collapse("show");
        })
        // scroll to the section
        $('html, body').animate({scrollTop: target.offset().top}, 1000);
      });
      ul.appendTo(cell);
    }

    function main_page_desktop() {
      var data    = jqXHR_iss_index_json.engines.data;
      var columns = jqXHR_iss_index_json.engines.columns;

      var main_tabs_ul      = $("<ul/>",  {
        'class' : "nav nav-tabs", 
           'id' : "tabs-main",
         'role' : "tablist"
      })
      var main_tabs_content = $("<div/>", {
        'class' : "tab-content",  
           'id' : "tabs-content-main"
      })

      create_tab(marker_row_home, "Главная", true).appendTo(main_tabs_ul);
      create_tab_content(marker_row_home, "Главная", true).appendTo(main_tabs_content);

      create_tab(marker_row_securities, "<font color='chocolate'><b>" + "Активы" + "</b></font>").appendTo(main_tabs_ul);
      create_tab_content(marker_row_securities, "Активы").appendTo(main_tabs_content);

      $.each( data, function( i, val ) {
        var badges                = "";
        var badge_markets         = "";
        var badge_securitytypes   = "";
        var badge_securitygroups  = "";

        if (map_jqXHR_iss_index_json_markets_data.has(val[columns.indexOf("id")])) {
          badge_markets = $("<span/>", {
            'class': "badge badge-info",  
            'html' : map_jqXHR_iss_index_json_markets_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_markets;
        }
        if (map_jqXHR_iss_index_json_securitygroups_data.has(val[columns.indexOf("name")])) {
          badge_securitygroups = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : map_jqXHR_iss_index_json_securitygroups_data.get(val[columns.indexOf("name")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_securitygroups;
        }
        if (map_jqXHR_iss_index_json_securitytypes_data.has(val[columns.indexOf("id")])) {
          badge_securitytypes = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : map_jqXHR_iss_index_json_securitytypes_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_securitytypes;
        }

        create_tab(prefix_engine + val[columns.indexOf("id")], val[columns.indexOf("title")] + badges).appendTo(main_tabs_ul);
        create_tab_content(prefix_engine + val[columns.indexOf("id")], val[columns.indexOf("title")] + badges).appendTo(main_tabs_content);
      });
      main_tabs_ul.appendTo( "body" );
      main_tabs_content.appendTo( "body" );
    }
    function main_page_mobile() {
      var data    = jqXHR_iss_index_json.engines.data;
      var columns = jqXHR_iss_index_json.engines.columns;

      var accordion  = $("<div/>", {'class':"accordion",  'id':prefix_accordion + "main"})
      create_card(marker_row_home, "Главная".toUpperCase(), "text-center mob-accordion-lev-1").appendTo(accordion);

      $.each( data, function( i, val ) {
        var badges                = "";
        var badge_markets         = "";
        var badge_securitytypes   = "";
        var badge_securitygroups  = "";

        if (map_jqXHR_iss_index_json_markets_data.has(val[columns.indexOf("id")])) {
          badge_markets = $("<span/>", {
            'class': "badge badge-info",  
            'html' : "Рынков: " + map_jqXHR_iss_index_json_markets_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_markets;
        }
        if (map_jqXHR_iss_index_json_securitygroups_data.has(val[columns.indexOf("name")])) {
          badge_securitygroups = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : "Инструменты - Групп: " + map_jqXHR_iss_index_json_securitygroups_data.get(val[columns.indexOf("name")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_securitygroups;
        }
        if (map_jqXHR_iss_index_json_securitytypes_data.has(val[columns.indexOf("id")])) {
          badge_securitytypes = $("<span/>", {
            'class': "badge badge-secondary",  
            'html' : "Инструменты - Типов: " + map_jqXHR_iss_index_json_securitytypes_data.get(val[columns.indexOf("id")]).length
          }).wrap('<p/>').parent().html();
          badges = badges + " " + badge_securitytypes;
        }

        create_card(
          prefix_engine + val[columns.indexOf("id")], 
          val[columns.indexOf("title")].toUpperCase() + badges, 
          "text-center mob-accordion-lev-1"
        ).appendTo(accordion);
      });
      accordion.appendTo( "body" );
      accordion.on('show.bs.collapse', process_event_show); // events
    }

    function console_log_requests_security (secid, sec_board, trades = true, candles = true, history = true) {                     //  sec_board from: https://iss.moex.com/iss/securities/{secid} (e.g. ABRD)
      //var primary     = get_iss_security_primary_board(secid);
      
      //!!!
      // https://iss.moex.com/iss/history/engines/futures/markets/options/dates
      // 2001-09-19  2020-06-05
      // https://iss.moex.com/iss/history/engines/futures/markets/options/securities?numtrades=1
      // https://iss.moex.com/iss/history/engines/futures/markets/options/securities?date=2001-09-19&numtrades=1
      // https://iss.moex.com/iss/history/engines/futures/markets/options/securities?date=2008-09-23&numtrades=1

      // https://iss.moex.com/iss/history/engines/stock/markets/shares/dates
      // 1997-03-24  2020-06-05
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities?numtrades=1
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities?date=1997-03-24&numtrades=1
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities?date=1997-03-24&numtrades=0
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities?date=2004-03-23&numtrades=1
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities/AFLT
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities/AFLT/dates

      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities/YUKO
      // https://iss.moex.com/iss/history/engines/stock/markets/shares/securities/YUKO/dates

      // https://iss.moex.com/iss/history/engines/futures/markets/options/boards/ROPD/securities/AF10000BI0/dates
      
      var engine      = get_iss_index_engine_by_id(sec_board.engine_id);
      var market      = get_iss_index_market_by_id(sec_board.market_id);
      var boardgroup  = get_iss_index_boardgroup_by_id(sec_board.board_group_id);
      var board       = get_iss_index_board_by_boardid(sec_board.boardid);          //      board from: https://iss.moex.com/iss/index
      // sec_board            engine          market                boardgroup    board
      // 0: "secid"           // 0: "id"      id'                   id'           // 0: "id"
      // 1: "boardid"         // 1: "name"    name'                 name'         // 1: "board_group_id"
      // 2: "title"           // 2: "title"   title'                title'        // 2: "engine_id"
      // 3: "board_group_id"                  marketplace'          is_default'   // 3: "market_id"
      // 4: "market_id"                       // added 2020-05-27   is_traded'    // 4: "boardid"
      // 5: "market"                          trade_engine_id'                    // 5: "board_title"
      // 6: "engine_id"                       trade_engine_name'                  // 6: "is_traded"
      // 7: "engine"                          trade_engine_title'                 // 7: "has_candles"
      // 8: "is_traded"                                                           // 8: "is_primary"
      // 9: "decimals"                                
      // 10: "history_from"                                
      // 11: "history_till"                    
      // 12: "listed_from"                    
      // 13: "listed_till"                    
      // 14: "is_primary"                    
      // 15: "currencyid"                    

      console.log("------- REQUESTS START"
        + " secid: "  + secid 
        + " board: "  + sec_board.boardid 
        + " history"  
        + " from: "   + sec_board.history_from 
        + " till: "   + sec_board.history_till
        + " -------");
      console.log("security board:");
      console.log(sec_board);
      if (trades) {
        // trades:
        // -- market:
        // /iss/engines/[engine]/markets/[market]/securities/[security]/trades
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/trades"
        console.log("trades: -- market: " + request);

        // -- board:
        // /iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/trades
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boards/"      + board.boardid
          + "/securities/"  + secid
          + "/trades"
        console.log("trades: -- board: " + request);
      }
      if (candles) {
        // candles:
        // -- market:
        // /iss/engines/[engine]/markets/[market]/securities/[security]/candles
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/candles"
        console.log("candles: -- market: " + request);
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/candles"
          + "?"
          + "iss.reverse=true"
          + "&"
          + "interval=1"
          + "&"
          + "from=2020-06-02"
          + "&"
          + "start=0"
        console.log("candles: -- market: " + request);
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/candles"
          + "?"
          + "iss.reverse=true"
          + "&"
          + "interval=1"
          + "&"
          + "from=2020-06-02"
          + "&"
          + "start=500"
        console.log("candles: -- market: " + request);
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/candles"
          + "?"
          + "iss.reverse=true"
          + "&"
          + "interval=24"
        console.log("candles: -- market: " + request);

        // /iss/engines/[engine]/markets/[market]/securities/[security]/candleborders
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/candleborders"
        console.log("candles: -- market: " + request);
        // -- boardgroup:
        // /iss/engines/[engine]/markets/[market]/boardgroups/[boardgroup]/securities/[security]/candles
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boardgroups/" + boardgroup.name
          + "/securities/"  + secid
          + "/candles"
        console.log("candles: -- boardgroup: " + request);
        // /iss/engines/[engine]/markets/[market]/boardgroups/[boardgroup]/securities/[security]/candleborders
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boardgroups/" + boardgroup.name
          + "/securities/"  + secid
          + "/candleborders"
        console.log("candles: -- boardgroup: " + request);
        // -- board:
        // /iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candles
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boards/"      + board.boardid
          + "/securities/"  + secid
          + "/candles"
        console.log("candles: -- board: " + request);

        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=1"  ; console.log("candles: -- board  1: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=4"  ; console.log("candles: -- board  4: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=7"  ; console.log("candles: -- board  7: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=10" ; console.log("candles: -- board 10: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=24" ; console.log("candles: -- board 24: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=31" ; console.log("candles: -- board 31: " + request);
        request = "https://iss.moex.com/iss"+"/engines/"+engine.name+"/markets/"+market.name+"/boards/"+board.boardid+"/securities/"+secid+"/candles?interval=60" ; console.log("candles: -- board 60: " + request);
        // /iss/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/candleborders
        request = "https://iss.moex.com/iss" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boards/"      + board.boardid
          + "/securities/"  + secid
          + "/candleborders"
        console.log("candles: -- board: " + request);
      }
      if (history) {
        // HISTORY
        // -- market:
        // /iss/history/engines/[engine]/markets/[market]/securities/[security]
        request = "https://iss.moex.com/iss/history" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
        console.log("HISTORY: -- market: " + request);
        request = "https://iss.moex.com/iss/history" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "?"
          + "sort_order=desc"
        console.log("HISTORY: -- market: " + request);
        // /iss/history/engines/[engine]/markets/[market]/securities/[security]/dates
        request = "https://iss.moex.com/iss/history" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/securities/"  + secid
          + "/dates"
        console.log("HISTORY: -- market: " + request);

        // /iss/history/engines/[engine]/markets/[market]/boards/[board]/securities/[security]
        request = "https://iss.moex.com/iss/history" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boards/"      + board.boardid
          + "/securities/"  + secid
        console.log("HISTORY: -- board: " + request);
        // /iss/history/engines/[engine]/markets/[market]/boards/[board]/securities/[security]/dates
        request = "https://iss.moex.com/iss/history" 
          + "/engines/"     + engine.name 
          + "/markets/"     + market.name
          + "/boards/"      + board.boardid
          + "/securities/"  + secid
          + "/dates"
        console.log("HISTORY: -- board: " + request);
      }
      console.log("------- REQUESTS END   -------");
    }

    // $.get( "http://www.google.com/", function( data ) {
    //   console.log(data);     
    // });
    // Access to XMLHttpRequest at 'https://www.google.com/' (redirected from 'http://www.google.com/') from origin 'http://192.168.196.146:8000' has been blocked by CORS policy: 
    // No 'Access-Control-Allow-Origin' header is present on the requested resource.
    //
    // SOLUTION:
    // $.get( "https://cors-anywhere.herokuapp.com/http://www.google.com/", function( data ) {
    //   console.log(data);     
    // });
    // CORS - BEGIN
    // https://www.html5rocks.com/en/tutorials/cors/
    // https://stackoverflow.com/questions/20035101/why-doesn-t-postman-get-a-no-access-control-allow-origin-header-is-present-on
    // https://medium.com/@dtkatz/3-ways-to-fix-the-cors-error-and-how-access-control-allow-origin-works-d97d55946d9
    // https://github.com/Rob--W/cors-anywhere/#documentation

    // Create the XHR object.
    function createCORSRequest(method, url) {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {
        // XHR for Chrome/Firefox/Opera/Safari.
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest != "undefined") {
        // XDomainRequest for IE.
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        // CORS not supported.
        xhr = null;
      }
      return xhr;
    }
    // Helper method to parse the title tag from the response.
    function getTitle(text) {
      return text.match('<title>(.*)?</title>')[1];
    }
    // Make the actual CORS request.
    function makeCorsRequest() {
      // This is a sample server that supports CORS.
      // var url = 'http://html5rocks-cors.s3-website-us-east-1.amazonaws.com/index.html';
      var url = 'http://google.com';
      var xhr = createCORSRequest('GET', url);
      if (!xhr) {
        alert('CORS not supported');
        return;
      }

      // Response handlers.
      xhr.onload = function() {
        var text = xhr.responseText;
        var title = getTitle(text);
        console.log('Response from CORS request to ' + url + ': ' + title);
      };

      xhr.onerror = function() {
        alert('Woops, there was an error making the CORS request to: ' + url);
      };

      xhr.send();
    }
    // CORS - END

  </script>
</html>
