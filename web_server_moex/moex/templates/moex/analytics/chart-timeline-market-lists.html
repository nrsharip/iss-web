<html>
  {% load static %}

  <title>{% block title %} Временной график: ценные бумаги по рынкам {% endblock %}</title>
  <!-- https://www.favicon-generator.org/ -->
  <link rel="apple-touch-icon" sizes="57x57" href='{% static "moex/icon2.ico/apple-icon-57x57.png" %}'>
  <link rel="apple-touch-icon" sizes="60x60" href='{% static "moex/icon2.ico/apple-icon-60x60.png" %}'>
  <link rel="apple-touch-icon" sizes="72x72" href='{% static "moex/icon2.ico/apple-icon-72x72.png" %}'>
  <link rel="apple-touch-icon" sizes="76x76" href='{% static "moex/icon2.ico/apple-icon-76x76.png" %}'>
  <link rel="apple-touch-icon" sizes="114x114" href='{% static "moex/icon2.ico/apple-icon-114x114.png" %}'>
  <link rel="apple-touch-icon" sizes="120x120" href='{% static "moex/icon2.ico/apple-icon-120x120.png" %}'>
  <link rel="apple-touch-icon" sizes="144x144" href='{% static "moex/icon2.ico/apple-icon-144x144.png" %}'>
  <link rel="apple-touch-icon" sizes="152x152" href='{% static "moex/icon2.ico/apple-icon-152x152.png" %}'>
  <link rel="apple-touch-icon" sizes="180x180" href='{% static "moex/icon2.ico/apple-icon-180x180.png" %}'>
  <link rel="icon" type="image/png" sizes="192x192"  href='{% static "moex/icon2.ico/android-icon-192x192.png" %}'>
  <link rel="icon" type="image/png" sizes="32x32" href='{% static "moex/icon2.ico/favicon-32x32.png" %}'>
  <link rel="icon" type="image/png" sizes="96x96" href='{% static "moex/icon2.ico/favicon-96x96.png" %}'>
  <link rel="icon" type="image/png" sizes="16x16" href='{% static "moex/icon2.ico/favicon-16x16.png" %}'>
  <!-- This one causing 404 for android icons going out of Django 'static' parser -->
  <!-- <link rel="manifest" href='{% static "moex/icon2.ico/manifest.json" %}'>   -->
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content='{% static "moex/icon2.ico/ms-icon-144x144.png" %}'>
  <meta name="theme-color" content="#ffffff">

  <div id="mobile-device-test"></div>

  <!-- jQuery CDN – Latest Stable Versions: https://code.jquery.com/ -->
  <!-- jQuery Core – All Versions:          https://code.jquery.com/jquery/ -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>

  <!-- DataTables CDN: https://cdn.datatables.net/ -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script> -->
  <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

  <!-- THIS SHOULD BE ADDED BEFORE CHART JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <!-- https://cdnjs.com/libraries/Chart.js -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.1"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.0.0-alpha/Chart.min.js"></script> -->
  
  <!-- https://github.com/chartjs/Chart.js -->
  <!-- <script src='{% static "moex/node_modules/Chart.js-master/samples/utils.js" %}'></script> -->

  <!-- Chart JS Plugins -->
  <!-- https://chartjs-plugin-datalabels.netlify.app/guide/ -->
  <script src='{% static "moex/node_modules/chartjs-plugin-datalabels/dist/chartjs-plugin-datalabels.min.js" %}'></script>

  <!-- https://github.com/chartjs/chartjs-chart-financial -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/luxon@1.24.1"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@0.2.1"></script> -->
  <!-- see https://github.com/chartjs/chartjs-chart-financial/commits/master -->
  <!-- commit before migration to chartjs 3.0.0 - f0c37e1dc24923a02c7793df8a292921db4b46cb -->
  <!-- <script src='{% static "moex/node_modules/chartjs-chart-financial-f0c37e1dc24923a02c7793df8a292921db4b46cb/docs/chartjs-chart-financial.js" %}' type="text/javascript"></script> -->
  <!-- <script src='{% static "moex/node_modules/chartjs-chart-financial-master/docs/index-1.js" %}' type="text/javascript"></script> -->

  <!-- https://github.com/chartjs/chartjs-plugin-zoom -->
  <!-- https://github.com/chartjs/chartjs-plugin-zoom/issues/53 -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src='{% static "moex/node_modules/chartjs-plugin-zoom/chartjs-plugin-zoom.min.js" %}' type="text/javascript"></script>

  <!-- https://bashooka.com/coding/9-useful-javascript-color-libraries/ -->
  <!-- chroma.js -->
  <!-- https://gka.github.io/chroma.js/ -->
  <!-- https://www.npmjs.com/package/chroma-js -->
  <!-- once out of DEBUG switch to min.js version -->
  <!-- <script src='{% static "moex/node_modules/chroma-js/chroma.min.js" %}'></script> -->
  <script src='{% static "moex/node_modules/chroma-js/chroma.js" %}'></script>

  <!-- https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/16.x/browser-builds.html -->
  <script src='{% static "moex/node_modules/elasticsearch-browser/elasticsearch.jquery.min.js" %}'></script>

  <!-- https://developers.google.com/chart/interactive/docs/gallery/timeline -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    .divider{
        width  :10px;
        height :auto;
        display:inline-block;
    }
  </style>

  <script src='{% static "moex/scripts/global.js" %}'></script>
  <script type="text/javascript">
  // https://stackoverflow.com/questions/50566194/correctly-accessing-django-static-files-from-external-javascript
  NG_STATIC_FILES = {
     //"HOME": "{% static '/pages/home.html' %}",
     //"SOMETHING_ELSE": "{% static '/pages/some-angular-template.html' %}",
     "SVG_QUESTION_CIRCLE" : '{% static "moex/node_modules/icons-master/icons/question-circle.svg" %}',
  };
  
  // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function
  // https://stackoverflow.com/questions/27612372/how-to-await-the-ajax-request
  // https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/index.html
  // https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/api-reference.html
  
  $( document ).ready(function() {
    var request = "http://iss.moex.com/iss/index.json"
    console.log("GET iss/index: " + request);
    // http://iss.moex.com/iss/reference/28
    // http://iss.moex.com/iss/index
    jQuery.get(request).done( function( data ) {
      jqXHR_iss_index_json = data;

      process_iss_index_markets();              // map_jqXHR_iss_index_json_markets_data              : engine -> markets
      process_iss_index_boardgroups();          // map_jqXHR_iss_index_json_boardgroups_data          : engine -> markets -> boardgroups
      process_iss_index_boards();               // map_jqXHR_iss_index_json_boards_data               : engine -> markets -> boardgroups -> boards
      process_iss_index_securitytypes();        // map_jqXHR_iss_index_json_securitytypes_data        : engine -> securitytypes
      process_iss_index_securitygroups();       // map_jqXHR_iss_index_json_securitygroups_data       : engine -> securitygroups
      process_iss_index_securitycollections();  // map_jqXHR_iss_index_json_securitycollection_data   : engine -> securitygroups -> securitycollection

/*
      var grid = $("<div/>", {'class' : "container-fluid", 'id' : prefix_grid + marker_row_home});  // grid-home
      grid.appendTo($('body'));

      var  row =  grid_create_row(grid, marker_row_main);                                           // grid-home-main
      var  col =  grid_create_col(row, "col-md-12 align-top", marker_col_entire);                   // grid-home-main-entire
           row =  grid_create_row(grid, marker_row_info);                                           // grid-home-info
      var cell =  grid_create_col(row, "col-md-12 align-top", marker_col_entire);                   // grid-home-info-entire
*/
      google.charts.load("current", {packages:["timeline"]});
      google.charts.setOnLoadCallback(main());
      
      
    }).fail( function() {
      // TODO: FINISH THIS PART
      // Power Outage causing Internet off. Switching to saved JSONs for now
      alert("Failed request: " + request);
    });
  });

  async function process_event_select_secid(secid, index_hist, index_list) {
    //console.log(secid)

    // https://stackoverflow.com/questions/18432394/how-to-make-twitter-bootstrap-modal-full-screen
    // https://www.w3schools.com/css/css_align.asp
    // https://getbootstrap.com/docs/4.2/components/modal/#via-javascript
    // https://getbootstrap.com/docs/4.2/components/modal/#options
    // https://getbootstrap.com/docs/4.2/components/modal/#methods

    // https://getbootstrap.com/docs/4.2/components/modal/#options
    // Name       Type                    Default     Description
    // backdrop   boolean                 true        Includes a modal-backdrop element. Alternatively, specify static for a backdrop which doesn't close the modal on click.
    //            or the string 'static'
    // keyboard   boolean                 true        Closes the modal when escape key is pressed
    // focus      boolean                 true        Puts the focus on the modal when initialized.
    // show       boolean                 true        Shows the modal when initialized.
    var options = {
      backdrop  : true,
      keyboard  : true,
      focus     : true,
      show      : true,
    }
    $('#modal-secid').find('.modal-dialog').css('max-width', '99%');
    $('#modal-secid').find('.modal-dialog').css('max-height', '99%');

    $('#modal-secid').find('.modal-header').css('padding-top',    '8px');
    $('#modal-secid').find('.modal-header').css('padding-bottom', '8px');

    $('#modal-label-secid').empty();
    var body = $('#modal-secid').find('.modal-body');
    // emptying the body
    body.empty();

    // Creating the grid container for the modal-body:
    var grid = $("<div/>", {'class' : "container-fluid", 'id' : prefix_grid + 'modal-secid'}) // grid-modal-secid
    grid.appendTo(body);
    var row = grid_create_row(grid, marker_row_main);                                         // grid-modal-secid-main
    var col_left    = null;
    var col_right   = null;
    var col_entire  = null;
    if (!is_mobile) {
      col_left    = grid_create_col(row, "col-md-7 align-top", marker_col_left);              // grid-modal-secid-main-left
      col_right   = grid_create_col(row, "col-md-5 align-top", marker_col_right);             // grid-modal-secid-main-right
    } else {
      col_entire  = grid_create_col(row, "col-md-12 align-top", marker_col_entire);           // grid-modal-secid-main-entire
    }
    // https://getbootstrap.com/docs/4.2/components/modal/#via-javascript
    $('#modal-secid').modal(options)

    var col = null;

    if (!is_mobile) {
      col = col_left;
    } else {
      col = col_entire;
    }

    // ES History
    // 
    subrow = grid_create_row(col);                                              // grid-modal-secid-main-{left|entire}-1
    subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-{left|entire}-1-entire
    grid_create_spinner(subcol, "Загрузка исторических данных из ES...");

    var response = await es_search({ 
      index   : index_hist, 
      size    : size_days_per_market,
      sort    : '_id',                  // currently _id is a string of date yyyy-MM-dd
      //sort    : 'history.TRADEDATE',
      body    : {
        // https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html
        // https://stackoverflow.com/questions/35589084/elasticsearch-return-only-nested-inner-hits
        "_source" : false,
        "query":  {
          "nested" : {
            "path" : "history",
            "query" : {
              "bool" : {
                "must" : [
                  { "match" : {"history.SECID" : secid} }
                  //{ "range" : {"obj1.count" : {"gt" : 5}} }
                  ]
              }
            },
            "inner_hits" : {}
            //"score_mode" : "avg"
          }
        }
      }
    });
    console.log(response)
    
    subcol.empty()
    subrow = grid_create_row(col);                                              // grid-modal-secid-main-{left|entire}-{2..}
    subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire); // grid-modal-secid-main-{left|entire}-{2..}-entire
    var canvas = grid_create_canvas(
      prefix_mixed + prefix_bar + prefix_line + prefix_es_index + index_hist + "-" + secid, 
      col, 
      subrow, 
      subcol
    );
    chart_create_mixed_bar_line_es_history_security (canvas, response)
      
      
    // security
    if (!is_mobile) {
      col = col_right;
    } else {
      col = col_entire;
    }
    // http://iss.moex.com/iss/reference/13  - http://iss.moex.com/iss/securities/AFKS
    var subrow = grid_create_row(col, marker_row_securities);                             // grid-modal-secid-main-{right|entire}-securities
    var subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);       // grid-modal-secid-main-{right|entire}-securities-entire
    grid_create_spinner(subcol);

    var request = "https://iss.moex.com/iss" + 
      "/securities/" + secid + 
      ".json" 
    console.log("GET security " + secid + " description: " + request);
    jQuery.get(request).done( function( description ) {
      console.log(description);
      var map = new Map();
      map.set(map_key_security_description,   description.description);
      map.set(map_key_security_boards,        description.boards);
      map_secid_jqXHR_iss_securities_security_json.set(secid, map);

      //var desc = new Map();
      //$.each(description.description.data, function( i, line ) {
      //  desc.set(line[description.description.columns.indexOf("name")], line[description.description.columns.indexOf("value")]);
      //});
      var desc = get_iss_security_description (secid);
      $('#modal-label-secid').html("<b>" + secid + "</b> - " + desc.get("NAME"));

      var q = "";
      q += desc.get("SECID")  ?     desc.get("SECID") : "";
      q += desc.get("ISIN")   ? " " + desc.get("ISIN")  : "";
      // https://stackoverflow.com/questions/6544564/url-encode-a-string-in-jquery-for-an-ajax-request
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
      q = encodeURIComponent(q);

      var request = "https://iss.moex.com/iss" 
        + "/securities.json" 
        + "?"
        + "q=" + q
      console.log("GET security " + secid + " securities: " + request);
      jQuery.get(request).done( function( securities ) {
        console.log(securities);
        if (securities.securities.data.length == 0) {
          alert("ERROR: Got 0 records for " + secid + " request: " + request);
          return;
        }
        if (securities.securities.data.length > 1) {
          console.log("WARNING: Got more than 1 record for " + secid + " request: " + request);
        }
        var map = map_secid_jqXHR_iss_securities_security_json.get(secid);
        map.set(map_key_security_securities_iss,  securities.securities);
        map_secid_jqXHR_iss_securities_security_json.set(secid, map);

        subcol.empty()
        
        // securities
        // 
        $("<h6/>", { style : "text-align: center; font-weight: bold;", html  : "Ценная бумага <font color='red'>" + secid + "</font>" }).appendTo(subcol);
        // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
        // https://getbootstrap.com/docs/4.2/content/tables/#small-table
        var table = grid_create_table(prefix_iss + marker_table_security + postfix_securities, col, subrow, subcol);
        table.table.addClass("table-borderless");
        table_fill_with_iss_security_securities(table, secid);

        // description
        // 
        subrow = grid_create_row(col, marker_row_description);                          // grid-modal-secid-main-{right|entire}-description
        subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);     // grid-modal-secid-main-{right|entire}-description-entire
        $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Описание ценной бумаги"}).appendTo(subcol);
        // https://getbootstrap.com/docs/4.2/content/tables/#borderless-table
        // https://getbootstrap.com/docs/4.2/content/tables/#small-table
        var table = grid_create_table(prefix_iss + marker_table_security + postfix_description, col, subrow, subcol);
        table.table.addClass("table-borderless");
        table_fill_with_iss_security_description(table, secid);
        
        // boards
        // 
        subrow = grid_create_row(col, marker_row_boards);                               // grid-modal-secid-main-{right|entire}-boards
        subcol = grid_create_col(subrow, "col-md-12 align-top", marker_col_entire);     // grid-modal-secid-main-{right|entire}-boards-entire
        $("<h6/>", { style : "text-align: center; font-weight: bold;", html: "Режимы торгов ценной бумагой <font color='red'>" + secid + "</font>" }).appendTo(subcol);
        var table = grid_create_table(prefix_iss + marker_table_security + postfix_boards, col, subrow, subcol);
        table_fill_with_iss_security_boards(table, secid);
        
      }).fail( function() {
        // TODO: FINISH THIS PART
        alert ("ERROR: Request failed: " + request);
      });
    }).fail( function() {
      // TODO: FINISH THIS PART
      alert ("ERROR: Request failed: " + request);
    });
  }
  function chart_create_mixed_bar_line_es_history_security(canvas , es_response) {
    var data_CLOSE      = new Array();
    var data_VOLUME     = new Array();
    var data_TRADEDATE  = new Array();
    $.each(es_response.hits.hits, function (i_h, hit) {
      var record = hit.inner_hits.history.hits.hits[0]._source; // expecting only 1 hit (record for the security) per day
      //ADMITTEDQUOTE: 411.815
      //ADMITTEDVALUE: 0
      //BOARDID: "TQBR"
      //CLOSE: 412.01
      //HIGH: 412.01
      //LEGALCLOSEPRICE: 411.815
      //LOW: 411.62
      //MARKETPRICE2: null
      //MARKETPRICE3: null
      //MARKETPRICE3TRADESVALUE: 0
      //MP2VALTRD: 0
      //NUMTRADES: 2
      //OPEN: 411.62
      //SECID: "ERCO"
      //SHORTNAME: "ЭРКО ао"
      //TRADEDATE: "2016-12-13"
      //TRADINGSESSION: 3
      //VALUE: 823630
      //VOLUME: 2000
      //WAPRICE: 411.815
      //WAVAL: null
      data_CLOSE.push(record.CLOSE);
      
      data_TRADEDATE.push(new Date(record.TRADEDATE));
      
      if (record.VOLUME) {
        data_VOLUME.push(record.VOLUME);
      } else if (record.VOLRUR) {         // hist-market-currency-selt has no VOLUME but VOLRUR
        data_VOLUME.push(record.VOLRUR);
      }
      
    })
    //console.log(data_CLOSE);
    //console.log(data_VOLUME);
    //console.log(data_TRADEDATE);

    var info = {
      datasets : [
        {
          // https://stackoverflow.com/questions/38085352/how-to-use-two-y-axes-in-chart-js-v2
          yAxisID: "volume",
          data  : data_VOLUME,//.slice(0, 6),
          label : "объём",
          // chroma.brewer.OrRd
          // (9) ["#fff7ec", "#fee8c8", "#fdd49e", "#fdbb84", "#fc8d59", "#ef6548", "#d7301f", "#b30000", "#7f0000"]
          backgroundColor: chroma("#d7301f").hex(),
          borderColor: 'white',
          //borderWidth: 2,
          order: 2,
        },
        {
          // https://stackoverflow.com/questions/38085352/how-to-use-two-y-axes-in-chart-js-v2
          yAxisID: "close",
          data  : data_CLOSE,//.slice(0, 6),
          label : "закрытие",
          type  : 'line',
          // https://stackoverflow.com/questions/46194039/how-to-change-size-of-point-in-chartjs
          pointRadius: 1,
          pointHoverRadius: 1,
          backgroundColor: 'white',
          // chroma.scale(['#fafa6e','#2A4858']).mode('lch').colors(6)
          // (6) ["#fafa6e", "#9cdf7c", "#4abd8c", "#00968e", "#106e7c", "#2a4858"]
          borderColor: chroma("#2a4858").alpha(0.6).hex(),
          borderWidth: 2,
          order: 1,
          fill: false,
        }
      ],

      labels: data_TRADEDATE,//.slice(0, 6),
      title: {
        display: false,
        //text: board.board_title,
      },
      ///////////
      scales: {
        xAxes: [{
          type: 'time',
          // https://www.chartjs.org/docs/latest/axes/cartesian/time.html
          time: {
            parser: 'MM/DD/YYYY HH:mm',
            // round: 'day'
            tooltipFormat: 'll HH:mm'
          },
          scaleLabel: {
            display: true,
            labelString: 'Date'
          },
          ticks: {
            maxRotation: 0
          }
        }],
        yAxes: [{
          id: 'volume',
          type: 'linear',
          position: 'right',
        }, {
          id: 'close',
          type: 'linear',
          position: 'left',
        }]
      },
    }
    //chartjs_zoom_test(canvas.canvas);
    chartjs_create_mixed_bar_line(canvas.canvas, info);
    return canvas;
  }
  async function main () {
    var height  = $(window).height();
    var width   = $(window).width();
    var colors = ['#d11141', '#00b159', '#00aedb', '#f37735', '#ffc425'];             // https://www.color-hex.com/color-palette/700
    colors = colors.concat(['#ed5555', '#b4c468', '#b8a7ea', '#b7e0dc', '#bdd1a0']);  // https://www.color-hex.com/color-palette/36398
    var i_color = 0;
    for (var i_m = 0; i_m < jqXHR_iss_index_json.markets.data.length; i_m += 1) {
    //for (var i_m = 0; i_m < 3; i_m += 1) {
      // 0: "id"
      // 1: "trade_engine_id"
      // 2: "trade_engine_name"
      // 3: "trade_engine_title"
      // 4: "market_name"
      // 5: "market_title"
      // 6: "market_id"
      // 7: "marketplace"
      var market = jqXHR_iss_index_json.markets.data[i_m];
      var es_index_list_market = 
        esi_list_market + "-" 
        + market[jqXHR_iss_index_json.markets.columns.indexOf("trade_engine_name")] + "-" 
        + market[jqXHR_iss_index_json.markets.columns.indexOf("market_name")];
      var es_index_hist_market = 
        esi_hist_market + "-" 
        + market[jqXHR_iss_index_json.markets.columns.indexOf("trade_engine_name")] + "-" 
        + market[jqXHR_iss_index_json.markets.columns.indexOf("market_name")];
      var request = "http://192.168.196.146:9200/" + es_index_list_market;
      console.log("HEAD request: " + request);
      
      // https://petetasker.com/using-async-await-jquerys-ajax
      try {
        // see https://api.jquery.com/jquery.ajax/
        await $.ajax({ url: request, type: 'GET', contentType: "application/json", dataType: "json" });
        
        var spinner = grid_create_spinner(null, "Загрузка: " + market[jqXHR_iss_index_json.markets.columns.indexOf("market_title")]);
        spinner.appendTo($('body'));
        
        var index_list_minmaxes = await es_search({ 
          index: es_index_list_market, 
          size : size_secs_per_market, 
          // https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-max-aggregation.html
          body : {
            "_source" : false,
            "aggs" : {
              "min_date" : { "min" : { "field" : "date_from" } },
              "max_date" : { "max" : { "field" : "date_till" } }
            }
          }
        });
        console.log(index_list_minmaxes);
        
        var date_list_min = index_list_minmaxes.aggregations.min_date.value ? new Date(index_list_minmaxes.aggregations.min_date.value) : null;
        var date_list_max = index_list_minmaxes.aggregations.max_date.value ? new Date(index_list_minmaxes.aggregations.max_date.value) : null;
        //date_list_max.setDate(date_list_max.getDate() + 1)
        console.log("Market list dates: " + date_list_min + " - " + date_list_max);
        
        var index_list_response = await es_search({ 
          index   : es_index_list_market, 
          size    : size_secs_per_market, 
          //_source : false,
          sort    : "date_from",
        });
        console.log(index_list_response);
        
        if (index_list_response.hits.hits.length == 0) { spinner.remove(); continue; }
        
        var line_total = 0;
        var obj_min = null;
        var obj_lines = {};
        var arr_rows  = new Array();
        $.each (index_list_response.hits.hits, function (i_h, hit) {
          if (hit._source.date_till !== null) {
            var line = 0;
          
            var from = new Date(hit._source.date_from);
            var till = new Date(hit._source.date_till);
            
            if (!obj_min) {
              obj_min = { line : 0, till : 0 };
              obj_min.line = line;
              obj_min.till = till.getTime();
            }
            
            if (from.getTime() > obj_min.till) {
              line = obj_min.line;
              obj_lines[line] = till.getTime();
              obj_min.till = till.getTime();
              
              for (l in obj_lines) {
                if (obj_lines[l] < obj_min.till) {
                  obj_min.line = l;
                  obj_min.till = obj_lines[l];
                }
              }
            } else {
              line = line_total;
              line_total += 1;
            }

            if (till.getTime() < obj_min.till) {
              obj_min.line = line;
              obj_min.till = till.getTime();
            }
            arr_rows.push([line.toString(), hit._source.secid, "", from, till]);
            obj_lines[line] = till.getTime();
          }
        })
        console.log ("Records in " + es_index_list_market + ": " + index_list_response.hits.hits.length);
        console.log ("Rows added: " + arr_rows.length);
        
        var h = $("<h5/>", { 
          class : "text-center", 
          html : market[jqXHR_iss_index_json.markets.columns.indexOf("market_title")]
            + " (<span class='text-muted'>" 
            + market[jqXHR_iss_index_json.markets.columns.indexOf("trade_engine_title")] 
            + "</span>) - " 
            + es_index_hist_market
        });
        h.appendTo($('body'));
        var div = $("<div/>", { id : es_index_list_market, })
        //div.css("width", $(window).width());
        //div.css("width", $(window).width() - 25);
        //div.css("height", $(window).height()/2);
        div.css("width",  width - 25);     // -25 for the scroll-bar...
        div.css("height", height * (3/4));
        div.appendTo($('body'));

        var container = document.getElementById(es_index_list_market);
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn({ type: 'string', id: 'num' });
        dataTable.addColumn({ type: 'string', id: 'secid' });
        dataTable.addColumn({ type: 'string', role: 'tooltip' });
        dataTable.addColumn({ type: 'date',   id: 'from' });
        dataTable.addColumn({ type: 'date',   id: 'till' });
        dataTable.addRows(arr_rows);
        var options = {
            timeline: { singleColor: colors[i_color % colors.length] },
            //timeline: { colorByRowLabel: true },
        };
        i_color += 1;
        spinner.remove(); 
        
        // https://developers.google.com/chart/interactive/docs/events
        // https://developers.google.com/chart/interactive/docs/gallery/timeline#events
        google.visualization.events.addListener(chart, 'select', (function (c, d, id) {
          //https://developers.google.com/chart/interactive/docs/reference#DataTable_getValue
          //!!! ISSUE FIXED WITH CLOSURE https://groups.google.com/forum/#!topic/google-visualization-api/p1avIYvcLWQ
          return function () {
            //selectHandler(baselinechart[x]);
            //console.log(c.getSelection());
            //console.log(d.getValue(c.getSelection()[0].row, 1)); // 1 column - secid
            var market = get_iss_index_market_by_id(id);
            var es_index_list_market = esi_list_market + "-" + market.trade_engine_name + "-" + market.name;
            var es_index_hist_market = esi_hist_market + "-" + market.trade_engine_name + "-" + market.name;
            console.log(es_index_list_market, es_index_hist_market, d.getValue(c.getSelection()[0].row, 1)); // 1 column - secid
            process_event_select_secid(d.getValue(c.getSelection()[0].row, 1), es_index_hist_market, es_index_list_market);
          }
          
        }) (chart, dataTable, market[jqXHR_iss_index_json.markets.columns.indexOf("id")]));
        
        chart.draw(dataTable, options);
        
        
        
      } catch (error) {
        console.log(error);
      }
    }
  }
  
  </script>
  <body>
    <div id="modal-secid" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-label-secid" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <span style="width: 100%; text-align: center; font-size: 20px;" class="modal-title" id="modal-label-secid"></span>
            <button type="button" class="close" data-dismiss="modal" aria-label="close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">
            ...
          </div>
        </div>
      </div>
    </div>
  </body>
</html>